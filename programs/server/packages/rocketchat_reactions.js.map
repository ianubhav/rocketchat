{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:reactions/server/models/Messages.js","meteor://ðŸ’»app/packages/rocketchat:reactions/setReaction.js","meteor://ðŸ’»app/packages/rocketchat:reactions/loadStylesheets.js"],"names":["RocketChat","models","Messages","setReactions","messageId","reactions","update","_id","$set","unsetReactions","$unset","Meteor","methods","setReaction","reaction","userId","Error","method","message","findOneById","room","call","rid","user","Array","isArray","muted","indexOf","username","Notifications","notifyUser","Random","id","ts","Date","msg","TAPi18n","__","language","Subscriptions","findOne","usernames","splice","length","_","isEmpty","push","msgStream","emit","theme","addPackageAsset","Assets","getText"],"mappings":"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","file":"/packages/rocketchat_reactions.js","sourcesContent":["RocketChat.models.Messages.setReactions = function(messageId, reactions) {\n\treturn this.update({ _id: messageId }, { $set: { reactions: reactions }});\n};\n\nRocketChat.models.Messages.unsetReactions = function(messageId) {\n\treturn this.update({ _id: messageId }, { $unset: { reactions: 1 }});\n};\n","/* globals msgStream */\nMeteor.methods({\n\tsetReaction(reaction, messageId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'setReaction' });\n\t\t}\n\n\t\tlet message = RocketChat.models.Messages.findOneById(messageId);\n\n\t\tlet room = Meteor.call('canAccessRoom', message.rid, Meteor.userId());\n\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'setReaction' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (Array.isArray(room.muted) && room.muted.indexOf(user.username) !== -1) {\n\t\t\tRocketChat.Notifications.notifyUser(Meteor.userId(), 'message', {\n\t\t\t\t_id: Random.id(),\n\t\t\t\trid: room._id,\n\t\t\t\tts: new Date(),\n\t\t\t\tmsg: TAPi18n.__('You_have_been_muted', {}, user.language)\n\t\t\t});\n\t\t\treturn false;\n\t\t} else if (!RocketChat.models.Subscriptions.findOne({ rid: message.rid })) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.reactions && message.reactions[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n\t\t\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n\n\t\t\tif (message.reactions[reaction].usernames.length === 0) {\n\t\t\t\tdelete message.reactions[reaction];\n\t\t\t}\n\n\t\t\tif (_.isEmpty(message.reactions)) {\n\t\t\t\tdelete message.reactions;\n\t\t\t\tRocketChat.models.Messages.unsetReactions(messageId);\n\t\t\t} else {\n\t\t\t\tRocketChat.models.Messages.setReactions(messageId, message.reactions);\n\t\t\t}\n\t\t} else {\n\t\t\tif (!message.reactions) {\n\t\t\t\tmessage.reactions = {};\n\t\t\t}\n\t\t\tif (!message.reactions[reaction]) {\n\t\t\t\tmessage.reactions[reaction] = {\n\t\t\t\t\tusernames: []\n\t\t\t\t};\n\t\t\t}\n\t\t\tmessage.reactions[reaction].usernames.push(user.username);\n\n\t\t\tRocketChat.models.Messages.setReactions(messageId, message.reactions);\n\t\t}\n\n\t\tmsgStream.emit(message.rid, message);\n\n\t\treturn;\n\t}\n});\n","RocketChat.theme.addPackageAsset(function() {\n\treturn Assets.getText('client/stylesheets/reaction.less');\n});\n"]}