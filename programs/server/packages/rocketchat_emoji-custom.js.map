{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:emoji-custom/function-isSet.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/startup/emoji-custom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/models/EmojiCustom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/publications/fullEmojiData.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/listEmojiCustom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/deleteEmojiCustom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/insertOrUpdateEmoji.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/uploadEmojiCustom.js"],"names":["isSet","fn","value","e","undefined","isSetNotNull","Meteor","startup","storeType","RocketChat","settings","get","RocketChatStore","RocketChatFile","Error","console","log","green","path","trim","RocketChatFileEmojiCustomInstance","name","absolutePath","WebApp","connectHandlers","use","bindEnvironment","req","res","params","emoji","decodeURIComponent","url","replace","_","isEmpty","writeHead","write","end","file","getFileWithReadStream","encodeURIComponent","setHeader","reqModifiedHeader","headers","color","initials","svg","fileUploadDate","uploadDate","toUTCString","Date","test","split","pop","length","readStream","pipe","addGroup","add","type","values","key","i18nLabel","enableQuery","_id","EmojiCustom","tryEnsureIndex","findOneByID","options","findOne","findByNameOrAlias","query","$or","aliases","find","findByNameOrAliasExceptID","except","$nin","setName","update","$set","setAliases","setExtension","extension","create","data","insert","removeByID","remove","models","_Base","publish","filter","limit","userId","ready","fields","s","sort","filterReg","RegExp","escapeRegExp","methods","listEmojiCustom","fetch","deleteEmojiCustom","emojiID","authz","hasPermission","method","deleteFile","Notifications","notifyAll","emojiData","insertOrUpdateEmoji","field","nameValidation","aliasValidation","input","Boolean","without","matchingResults","alias","concat","createEmoji","newFile","previousExtension","previousName","rs","ws","createWriteStream","contentType","on","uploadEmojiCustom","binaryContent","Buffer","bufferToStream","setTimeout"],"mappings":"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","file":"/packages/rocketchat_emoji-custom.js","sourcesContent":["/* globals isSet:true, isSetNotNull:true */\n//http://stackoverflow.com/a/26990347 function isSet() from Gajus\nisSet = function(fn) {\n\tvar value;\n\ttry {\n\t\tvalue = fn();\n\t} catch (e) {\n\t\tvalue = undefined;\n\t} finally {\n\t\treturn value !== undefined;\n\t}\n};\n\nisSetNotNull = function(fn) {\n\tvar value;\n\ttry {\n\t\tvalue = fn();\n\t} catch (e) {\n\t\tvalue = null;\n\t} finally {\n\t\treturn value !== null && value !== undefined;\n\t}\n};\n\n/* exported isSet, isSetNotNull */\n","/* globals isSetNotNull, RocketChatFileEmojiCustomInstance */\nMeteor.startup(function() {\n\tlet storeType = 'GridFS';\n\n\tif (RocketChat.settings.get('EmojiUpload_Storage_Type')) {\n\t\tstoreType = RocketChat.settings.get('EmojiUpload_Storage_Type');\n\t}\n\n\tlet RocketChatStore = RocketChatFile[storeType];\n\n\tif (!isSetNotNull(() => RocketChatStore)) {\n\t\tthrow new Error(`Invalid RocketChatStore type [${storeType}]`);\n\t}\n\n\tconsole.log(`Using ${storeType} for custom emoji storage`.green);\n\n\tlet path = '~/uploads';\n\tif (isSetNotNull(() => RocketChat.settings.get('EmojiUpload_FileSystemPath'))) {\n\t\tif (RocketChat.settings.get('EmojiUpload_FileSystemPath').trim() !== '') {\n\t\t\tpath = RocketChat.settings.get('EmojiUpload_FileSystemPath');\n\t\t}\n\t}\n\n\tthis.RocketChatFileEmojiCustomInstance = new RocketChatStore({\n\t\tname: 'custom_emoji',\n\t\tabsolutePath: path\n\t});\n\n\treturn WebApp.connectHandlers.use('/emoji-custom/', Meteor.bindEnvironment(function(req, res/*, next*/) {\n\t\tlet params =\n\t\t\t{emoji: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, ''))};\n\n\t\tif (_.isEmpty(params.emoji)) {\n\t\t\tres.writeHead(403);\n\t\t\tres.write('Forbidden');\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tlet file = RocketChatFileEmojiCustomInstance.getFileWithReadStream(encodeURIComponent(params.emoji));\n\n\t\tres.setHeader('Content-Disposition', 'inline');\n\n\t\tif (!isSetNotNull(() => file)) {\n\t\t\t//use code from username initials renderer until file upload is complete\n\t\t\tres.setHeader('Content-Type', 'image/svg+xml');\n\t\t\tres.setHeader('Cache-Control', 'public, max-age=0');\n\t\t\tres.setHeader('Expires', '-1');\n\t\t\tres.setHeader('Last-Modified', 'Thu, 01 Jan 2015 00:00:00 GMT');\n\n\t\t\tlet reqModifiedHeader = req.headers['if-modified-since'];\n\t\t\tif (reqModifiedHeader != null) {\n\t\t\t\tif (reqModifiedHeader === 'Thu, 01 Jan 2015 00:00:00 GMT') {\n\t\t\t\t\tres.writeHead(304);\n\t\t\t\t\tres.end();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet color = '#000';\n\t\t\tlet initials = '?';\n\n\t\t\tlet svg = `<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg xmlns=\"http://www.w3.org/2000/svg\" pointer-events=\"none\" width=\"50\" height=\"50\" style=\"width: 50px; height: 50px; background-color: ${color};\">\n\t<text text-anchor=\"middle\" y=\"50%\" x=\"50%\" dy=\"0.36em\" pointer-events=\"auto\" fill=\"#ffffff\" font-family=\"Helvetica, Arial, Lucida Grande, sans-serif\" style=\"font-weight: 400; font-size: 28px;\">\n\t\t${initials}\n\t</text>\n</svg>`;\n\n\t\t\tres.write(svg);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tlet fileUploadDate = undefined;\n\t\tif (isSetNotNull(() => file.uploadDate)) {\n\t\t\tfileUploadDate = file.uploadDate.toUTCString();\n\t\t}\n\n\t\tlet reqModifiedHeader = req.headers['if-modified-since'];\n\t\tif (isSetNotNull(() => reqModifiedHeader)) {\n\t\t\tif (reqModifiedHeader === fileUploadDate) {\n\t\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\t\tres.writeHead(304);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tres.setHeader('Cache-Control', 'public, max-age=0');\n\t\tres.setHeader('Expires', '-1');\n\t\tif (isSetNotNull(() => fileUploadDate)) {\n\t\t\tres.setHeader('Last-Modified', fileUploadDate);\n\t\t} else {\n\t\t\tres.setHeader('Last-Modified', new Date().toUTCString());\n\t\t}\n\t\tif (/^svg$/i.test(params.emoji.split('.').pop())) {\n\t\t\tres.setHeader('Content-Type', 'image/svg+xml');\n\t\t} else {\n\t\t\tres.setHeader('Content-Type', 'image/jpeg');\n\t\t}\n\t\tres.setHeader('Content-Length', file.length);\n\n\t\tfile.readStream.pipe(res);\n\t}));\n});\n","RocketChat.settings.addGroup('EmojiCustomFilesystem', function() {\n\tthis.add('EmojiUpload_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\ti18nLabel: 'FileUpload_Storage_Type'\n\t});\n\n\tthis.add('EmojiUpload_FileSystemPath', '', {\n\t\ttype: 'string',\n\t\tenableQuery: {\n\t\t\t_id: 'EmojiUpload_Storage_Type',\n\t\t\tvalue: 'FileSystem'\n\t\t},\n\t\ti18nLabel: 'FileUpload_FileSystemPath'\n\t});\n});\n","class EmojiCustom extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('custom_emoji');\n\n\t\tthis.tryEnsureIndex({ 'name': 1 });\n\t\tthis.tryEnsureIndex({ 'aliases': 1 });\n\t\tthis.tryEnsureIndex({ 'extension': 1});\n\t}\n\n\t//find one\n\tfindOneByID(_id, options) {\n\t\treturn this.findOne(_id, options);\n\t}\n\n\t//find\n\tfindByNameOrAlias(name, options) {\n\t\tlet query = {\n\t\t\t$or: [\n\t\t\t\t{name},\n\t\t\t\t{aliases: name}\n\t\t\t]\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\tfindByNameOrAliasExceptID(name, except, options) {\n\t\tlet query = {\n\t\t\t_id: { $nin: [ except ] },\n\t\t\t$or: [\n\t\t\t\t{name},\n\t\t\t\t{aliases: name}\n\t\t\t]\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\n\t//update\n\tsetName(_id, name) {\n\t\tlet update = {\n\t\t\t$set: {\n\t\t\t\tname\n\t\t\t}\n\t\t};\n\n\t\treturn this.update({_id}, update);\n\t}\n\n\tsetAliases(_id, aliases) {\n\t\tlet update = {\n\t\t\t$set: {\n\t\t\t\taliases\n\t\t\t}\n\t\t};\n\n\t\treturn this.update({_id}, update);\n\t}\n\n\tsetExtension(_id, extension) {\n\t\tlet update = {\n\t\t\t$set: {\n\t\t\t\textension\n\t\t\t}\n\t\t};\n\n\t\treturn this.update({_id}, update);\n\t}\n\n\t// INSERT\n\tcreate(data) {\n\t\treturn this.insert(data);\n\t}\n\n\n\t// REMOVE\n\tremoveByID(_id) {\n\t\treturn this.remove(_id);\n\t}\n}\n\nRocketChat.models.EmojiCustom = new EmojiCustom();\n","Meteor.publish('fullEmojiData', function(filter, limit) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tlet fields = {\n\t\tname: 1,\n\t\taliases: 1,\n\t\textension: 1\n\t};\n\n\tfilter = s.trim(filter);\n\n\tlet options = {\n\t\tfields,\n\t\tlimit,\n\t\tsort: { name: 1 }\n\t};\n\n\tif (filter) {\n\t\tlet filterReg = new RegExp(s.escapeRegExp(filter), 'i');\n\t\treturn RocketChat.models.EmojiCustom.findByNameOrAlias(filterReg, options);\n\t}\n\n\treturn RocketChat.models.EmojiCustom.find({}, options);\n});\n","Meteor.methods({\n\tlistEmojiCustom() {\n\t\treturn RocketChat.models.EmojiCustom.find({}).fetch();\n\t}\n});\n","/* globals isSetNotNull, RocketChatFileEmojiCustomInstance */\nMeteor.methods({\n\tdeleteEmojiCustom(emojiID) {\n\t\tlet emoji = null;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-emoji')) {\n\t\t\temoji = RocketChat.models.EmojiCustom.findOneByID(emojiID);\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tif (!isSetNotNull(() => emoji)) {\n\t\t\tthrow new Meteor.Error('Custom_Emoji_Error_Invalid_Emoji', 'Invalid emoji', { method: 'deleteEmojiCustom' });\n\t\t}\n\n\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${emoji.name}.${emoji.extension}`));\n\t\tRocketChat.models.EmojiCustom.removeByID(emojiID);\n\t\tRocketChat.Notifications.notifyAll('deleteEmojiCustom', {emojiData: emoji});\n\n\t\treturn true;\n\t}\n});\n","/* globals RocketChatFileEmojiCustomInstance */\nMeteor.methods({\n\tinsertOrUpdateEmoji(emojiData) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-emoji')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tif (!s.trim(emojiData.name)) {\n\t\t\tthrow new Meteor.Error('error-the-field-is-required', 'The field Name is required', { method: 'insertOrUpdateEmoji', field: 'Name' });\n\t\t}\n\n\t\t//let nameValidation = new RegExp('^[0-9a-zA-Z-_+;.]+$');\n\t\t//let aliasValidation = new RegExp('^[0-9a-zA-Z-_+;., ]+$');\n\n\t\t//allow all characters except colon, whitespace, comma, >, <, &, \", ', /, \\, (, )\n\t\t//more practical than allowing specific sets of characters; also allows foreign languages\n\t\tlet nameValidation = /[\\s,:><&\"'\\/\\\\\\(\\)]/;\n\t\tlet aliasValidation = /[:><&\"'\\/\\\\\\(\\)]/;\n\n\t\t//silently strip colon; this allows for uploading :emojiname: as emojiname\n\t\temojiData.name = emojiData.name.replace(/:/g, '');\n\t\temojiData.aliases = emojiData.aliases.replace(/:/g, '');\n\n\t\tif (nameValidation.test(emojiData.name)) {\n\t\t\tthrow new Meteor.Error('error-input-is-not-a-valid-field', `${emojiData.name} is not a valid name`, { method: 'insertOrUpdateEmoji', input: emojiData.name, field: 'Name' });\n\t\t}\n\n\t\tif (emojiData.aliases) {\n\t\t\tif (aliasValidation.test(emojiData.aliases)) {\n\t\t\t\tthrow new Meteor.Error('error-input-is-not-a-valid-field', `${emojiData.aliases} is not a valid alias set`, { method: 'insertOrUpdateEmoji', input: emojiData.aliases, field: 'Alias_Set' });\n\t\t\t}\n\t\t\temojiData.aliases = emojiData.aliases.split(/[\\s,]/);\n\t\t\temojiData.aliases = emojiData.aliases.filter(Boolean);\n\t\t\temojiData.aliases = _.without(emojiData.aliases, emojiData.name);\n\t\t} else {\n\t\t\temojiData.aliases = [];\n\t\t}\n\n\t\tlet matchingResults = [];\n\n\t\tif (emojiData._id) {\n\t\t\tmatchingResults = RocketChat.models.EmojiCustom.findByNameOrAliasExceptID(emojiData.name, emojiData._id).fetch();\n\t\t\tfor (let alias of emojiData.aliases) {\n\t\t\t\tmatchingResults = matchingResults.concat(RocketChat.models.EmojiCustom.findByNameOrAliasExceptID(alias, emojiData._id).fetch());\n\t\t\t}\n\t\t} else {\n\t\t\tmatchingResults = RocketChat.models.EmojiCustom.findByNameOrAlias(emojiData.name).fetch();\n\t\t\tfor (let alias of emojiData.aliases) {\n\t\t\t\tmatchingResults = matchingResults.concat(RocketChat.models.EmojiCustom.findByNameOrAlias(alias).fetch());\n\t\t\t}\n\t\t}\n\n\t\tif (matchingResults.length > 0) {\n\t\t\tthrow new Meteor.Error('Custom_Emoji_Error_Name_Or_Alias_Already_In_Use', 'The custom emoji or one of its aliases is already in use', { method: 'insertOrUpdateEmoji' });\n\t\t}\n\n\t\tif (!emojiData._id) {\n\t\t\t//insert emoji\n\t\t\tlet createEmoji = {\n\t\t\t\tname: emojiData.name,\n\t\t\t\taliases: emojiData.aliases,\n\t\t\t\textension: emojiData.extension\n\t\t\t};\n\n\t\t\tlet _id = RocketChat.models.EmojiCustom.create(createEmoji);\n\n\t\t\tRocketChat.Notifications.notifyAll('updateEmojiCustom', {emojiData: createEmoji});\n\n\t\t\treturn _id;\n\t\t} else {\n\t\t\t//update emoji\n\t\t\tif (emojiData.newFile) {\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${emojiData.name}.${emojiData.extension}`));\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${emojiData.name}.${emojiData.previousExtension}`));\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${emojiData.previousName}.${emojiData.extension}`));\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${emojiData.previousName}.${emojiData.previousExtension}`));\n\n\t\t\t\tRocketChat.models.EmojiCustom.setExtension(emojiData._id, emojiData.extension);\n\t\t\t} else if (emojiData.name !== emojiData.previousName) {\n\t\t\t\tlet rs = RocketChatFileEmojiCustomInstance.getFileWithReadStream(encodeURIComponent(`${emojiData.previousName}.${emojiData.previousExtension}`));\n\t\t\t\tif (rs !== null) {\n\t\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${emojiData.name}.${emojiData.extension}`));\n\t\t\t\t\tlet ws = RocketChatFileEmojiCustomInstance.createWriteStream(encodeURIComponent(`${emojiData.name}.${emojiData.previousExtension}`), rs.contentType);\n\t\t\t\t\tws.on('end', Meteor.bindEnvironment(() =>\n\t\t\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${emojiData.previousName}.${emojiData.previousExtension}`))\n\t\t\t\t\t\t));\n\t\t\t\t\trs.readStream.pipe(ws);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (emojiData.name !== emojiData.previousName) {\n\t\t\t\tRocketChat.models.EmojiCustom.setName(emojiData._id, emojiData.name);\n\t\t\t}\n\n\t\t\tif (emojiData.aliases) {\n\t\t\t\tRocketChat.models.EmojiCustom.setAliases(emojiData._id, emojiData.aliases);\n\t\t\t} else {\n\t\t\t\tRocketChat.models.EmojiCustom.setAliases(emojiData._id, []);\n\t\t\t}\n\n\t\t\tRocketChat.Notifications.notifyAll('updateEmojiCustom', {emojiData});\n\n\t\t\treturn true;\n\t\t}\n\t}\n});\n","/* globals RocketChatFileEmojiCustomInstance */\nMeteor.methods({\n\tuploadEmojiCustom(binaryContent, contentType, emojiData) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-emoji')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\t//delete aliases for notification purposes. here, it is a string rather than an array\n\t\tdelete emojiData.aliases;\n\t\tlet file = new Buffer(binaryContent, 'binary');\n\n\t\tlet rs = RocketChatFile.bufferToStream(file);\n\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${emojiData.name}.${emojiData.extension}`));\n\t\tlet ws = RocketChatFileEmojiCustomInstance.createWriteStream(encodeURIComponent(`${emojiData.name}.${emojiData.extension}`), contentType);\n\t\tws.on('end', Meteor.bindEnvironment(() =>\n\t\t\tMeteor.setTimeout(() => RocketChat.Notifications.notifyAll('updateEmojiCustom', {emojiData})\n\t\t\t, 500)\n\t\t));\n\n\t\trs.pipe(ws);\n\t}\n});\n"]}