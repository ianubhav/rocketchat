{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:livechat/livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/startup.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/externalMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/markRoomResponded.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/offlineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/sendToCRM.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/addAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/addManager.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/changeLivechatStatus.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/closeByVisitor.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/closeRoom.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getCustomFields.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getInitialData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/loginByToken.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/pageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/registerGuest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeManager.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveInfo.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveIntegration.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveSurveyFeedback.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/searchAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendMessageLivechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendOfflineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/setCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/startVideoCall.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/transfer.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/webhookTest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/takeInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/returnAsInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveOfficeHours.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendTranscript.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Users.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Rooms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatExternalMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartmentAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatPageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/indexes.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatOfficeHour.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/Livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/QueueMethods.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/OfficeClock.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/sendMessageBySMS.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/unclosedLivechats.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/customFields.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/departmentAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/externalMessages.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatDepartments.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatIntegration.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatManagers.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatRooms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatQueue.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorHistory.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorInfo.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorPageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatInquiries.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatOfficeHours.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api.js","meteor://ðŸ’»app/packages/rocketchat:livechat/permissions.js","meteor://ðŸ’»app/packages/rocketchat:livechat/messageTypes.js","meteor://ðŸ’»app/packages/rocketchat:livechat/roomType.js","meteor://ðŸ’»app/packages/rocketchat:livechat/config.js","meteor://ðŸ’»app/packages/rocketchat:livechat/client/stylesheets/load.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/departments.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/sms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/users.js"],"names":["url","WebApp","Package","webapp","Autoupdate","autoupdate","connectHandlers","use","Meteor","bindEnvironment","req","res","next","reqUrl","parse","pathname","setHeader","head","Assets","getText","html","autoupdateVersion","JSON","stringify","__meteor_runtime_config__","write","end","startup","RocketChat","roomTypes","setPublish","code","models","Rooms","findLivechatByCode","name","t","cl","u","label","usernames","v","livechatData","topic","tags","sms","open","authz","addRoomAccessValidator","room","user","hasPermission","_id","callbacks","add","Error","TAPi18n","__","lng","language","settings","get","priority","LOW","knowledgeEnabled","apiaiKey","apiaiLanguage","key","value","message","editedAt","token","defer","response","HTTP","post","data","query","msg","lang","headers","status","_","isEmpty","result","fulfillment","speech","LivechatExternalMessage","insert","rid","orig","ts","Date","e","SystemLogger","error","waitingResponse","now","setResponseByRoomId","username","responseDate","responseTime","getTime","postData","type","sentAt","visitor","email","Livechat","sendRequest","MEDIUM","sendToCRM","hook","getLivechatRoomGuestInfo","messages","Messages","findVisibleByRoomId","sort","forEach","agentId","push","saveCRMDataByRoomId","methods","userId","method","addAgent","addManager","newStatus","statusLivechat","Users","setLivechatStatus","findOneOpenByVisitorId","closeRoom","comment","roomId","findOneById","indexOf","LivechatCustomField","find","fetch","visitorToken","info","enabled","title","color","registrationForm","triggers","departments","online","offlineColor","offlineMessage","offlineSuccessMessage","offlineUnavailableMessage","displayOfflineForm","videoCall","findOpenByVisitorToken","fields","length","initSettings","getInitSettings","Livechat_title","Livechat_title_color","Livechat_enabled","Livechat_registration_form","offlineTitle","Livechat_offline_title","Livechat_offline_title_color","Livechat_offline_message","Livechat_offline_success_message","Livechat_offline_form_unavailable","Livechat_display_offline_form","Language","Livechat_videocall_enabled","Jitsi_Enabled","transcript","Livechat_enable_transcript","transcriptMessage","Livechat_transcript_message","LivechatTrigger","trigger","LivechatDepartment","findEnabledWithAgents","department","findOnlineAgents","count","getVisitorByToken","stampedToken","Accounts","_generateStampedLoginToken","hashStampedToken","_hashStampedToken","updateUser","$set","services","resume","loginTokens","users","update","pageInfo","savePageHistory","registerGuest","call","loginToken","LivechatPageVisited","keepHistoryForToken","removeAgent","check","String","customField","removeById","removeDepartment","removeManager","removeAll","customFieldData","Match","ObjectIncluding","field","scope","visibility","test","createOrUpdateCustomField","departmentData","departmentAgents","saveDepartment","guestData","roomData","Optional","phone","ret","saveGuest","saveRoomInfo","run","values","updateById","s","trim","visitorRoom","formData","undefined","profile","updateData","item","contains","updateSurveyFeedbackById","save","isString","findOneByUsername","sendMessageLivechat","guest","findOne","sendMessage","header","placeholders","replace","footer","fromEmail","match","Email","send","to","from","replyTo","subject","substring","DDPRateLimiter","addRule","connectionId","updateLivechatDataByToken","Random","id","getRoom","jitsiTimeout","createWithTypeRoomIdMessageAndUser","actionLinks","icon","i18nLabel","method_id","params","domain","jitsiRoom","CryptoJS","MD5","toString","transferData","deparmentId","transfer","postCatchError","wrapAsync","options","resolve","err","unblock","sampleData","createdAt","lastMessageAt","customFields","productId","ip","browser","os","customerId","agent","console","log","statusCode","inquiryId","inquiry","LivechatInquiry","subscriptionData","alert","unread","desktopNotifications","mobilePushNotifications","emailNotifications","Subscriptions","concat","changeAgentByRoomId","servedBy","takeInquiry","removeByRoomId","removeUsernameById","openInquiry","day","start","finish","LivechatOfficeHour","updateHours","userLanguage","author","datetime","moment","locale","format","singleMessage","emailSettings","setOperator","operator","statusConnection","$exists","$ne","roles","findAgents","findOnlineUserFromList","userList","$in","getNextAgent","collectionObj","model","rawCollection","findAndModify","livechatCount","$inc","findVisitorByToken","closeOffice","self","openOffice","findOneVisitorByPhone","getNextVisitorUsername","settingsRaw","Settings","surveyFeedback","findLivechat","filter","offset","limit","extend","parseInt","getNextLivechatRoomCode","findByVisitorToken","findByVisitorId","visitorId","responseBy","$unset","closeByRoomId","closeInfo","closedBy","closedAt","chatDuration","setLabelByRoomId","findOpenByAgent","newUsernames","newAgent","crmData","findByRoomId","_Base","extraData","record","remove","findByDepartmentId","createOrUpdateDepartment","description","agents","numAgents","savedAgents","pluck","LivechatDepartmentAgents","agentsToSave","difference","removeByDepartmentIdAndAgentId","saveAgent","departmentId","order","$gt","upsert","getNextAgentForDepartment","onlineUsers","onlineUsernames","getOnlineForDepartment","depAgents","findUsersInQueue","usersList","tryEnsureIndex","sparse","expireAfterSeconds","saveByToken","keepHistoryMiliseconds","page","expireAt","findByToken","multi","getStatus","newStart","newFinish","newOpen","isNowWithinHours","currentTime","utc","todaysOfficeHours","isBefore","isBetween","isOpeningTime","isSame","isClosingTime","UAParser","historyMonitorType","logger","Logger","sections","webhook","getAgents","getOnlineAgents","roomInfo","newRoom","routingMethod","QueueMethods","alias","$addToSet","existingUser","findOneByEmailAddress","globalRoles","userData","connection","userAgent","httpHeaders","clientAddress","host","insertUserDoc","phoneNumber","number","emails","address","saveUserById","groupable","hideByRoomIdAndUserId","createCommandWithRoomIdAndUser","findNotHiddenPublic","setting","saveRoomById","updateNameByRoomId","closeOpenChats","forwardOpenChats","change","without","removeByRoomIdAndUserId","createUserLeaveWithRoomIdAndUser","createUserJoinWithRoomIdAndUser","callback","trying","warn","setTimeout","ua","setUA","lm","getOS","version","getBrowser","addUserRoles","removeUserFromRoles","Maybe","Boolean","roomCode","msgs","agentIds","setInterval","SMS","SMSService","getService","agentsHandler","monitorAgents","actionTimeout","onlineAgents","queue","clearTimeout","exists","runAgentLeaveAction","action","observeChanges","added","changed","removed","stop","UserPresenceMonitor","onSetUserStatus","publish","handle","getUsersInRole","ready","onStop","findByIds","RegExp","StartDate","ToDate","setDate","getDate","$lt","handleDepts","findById","Roles","createOrUpdate","Permissions","MessageTypes","registerType","system","register","isClient","TabBar","setTemplate","$","css","openFlex","isServer","Notifications","notifyRoom","setHiddenById","template","route","path","openRoom","showGroup","link","sub","findRoom","identifier","ChatRoom","roomName","condition","hasAllPermission","canSendMessage","notSubscribedTpl","addGroup","group","section","i18nDescription","enableQuery","theme","addPackageAsset","API","v1","addRoute","authRequired","unauthorized","success","bodyParams","Object","Array","failure","urlParams","put","service","rooms","body","extra","fromCountry","fromState","fromCity","role","map","pick"],"mappings":"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","file":"/packages/rocketchat_livechat.js","sourcesContent":["/* globals WebApp:true */\nimport url from 'url';\n\nWebApp = Package.webapp.WebApp;\nconst Autoupdate = Package.autoupdate.Autoupdate;\n\nWebApp.connectHandlers.use('/livechat', Meteor.bindEnvironment((req, res, next) => {\n\tconst reqUrl = url.parse(req.url);\n\tif (reqUrl.pathname !== '/') {\n\t\treturn next();\n\t}\n\tres.setHeader('content-type', 'text/html; charset=utf-8');\n\n\tconst head = Assets.getText('public/head.html');\n\n\tconst html = `<html>\n\t\t<head>\n\t\t\t<link rel=\"stylesheet\" type=\"text/css\" class=\"__meteor-css__\" href=\"/livechat/livechat.css?_dc=${Autoupdate.autoupdateVersion}\">\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\t__meteor_runtime_config__ = ${JSON.stringify(__meteor_runtime_config__)};\n\t\t\t</script>\n\n\t\t\t${head}\n\t\t</head>\n\t\t<body>\n\t\t\t<script type=\"text/javascript\" src=\"/livechat/livechat.js?_dc=${Autoupdate.autoupdateVersion}\"></script>\n\t\t</body>\n\t</html>`;\n\n\tres.write(html);\n\tres.end();\n}));\n","Meteor.startup(() => {\n\tRocketChat.roomTypes.setPublish('l', (code) => {\n\t\treturn RocketChat.models.Rooms.findLivechatByCode(code, {\n\t\t\tname: 1,\n\t\t\tt: 1,\n\t\t\tcl: 1,\n\t\t\tu: 1,\n\t\t\tlabel: 1,\n\t\t\tusernames: 1,\n\t\t\tv: 1,\n\t\t\tlivechatData: 1,\n\t\t\ttopic: 1,\n\t\t\ttags: 1,\n\t\t\tsms: 1,\n\t\t\tcode: 1,\n\t\t\topen: 1\n\t\t});\n\t});\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user) {\n\t\treturn room.t === 'l' && RocketChat.authz.hasPermission(user._id, 'view-livechat-rooms');\n\t});\n\n\tRocketChat.callbacks.add('beforeLeaveRoom', function(user, room) {\n\t\tif (room.t !== 'l') {\n\t\t\treturn user;\n\t\t}\n\t\tthrow new Meteor.Error(TAPi18n.__('You_cant_leave_a_livechat_room_Please_use_the_close_button', {\n\t\t\tlng: user.language || RocketChat.settings.get('language') || 'en'\n\t\t}));\n\t}, RocketChat.callbacks.priority.LOW, 'cant-leave-room');\n});\n","/* globals HTTP, SystemLogger */\n\nvar knowledgeEnabled = false;\nvar apiaiKey = '';\nvar apiaiLanguage = 'en';\nRocketChat.settings.get('Livechat_Knowledge_Enabled', function(key, value) {\n\tknowledgeEnabled = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Key', function(key, value) {\n\tapiaiKey = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Language', function(key, value) {\n\tapiaiLanguage = value;\n});\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!knowledgeEnabled) {\n\t\treturn message;\n\t}\n\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message hasn't a token, it was not sent by the visitor, so ignore it\n\tif (!message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\ttry {\n\t\t\tconst response = HTTP.post('https://api.api.ai/api/query?v=20150910', {\n\t\t\t\tdata: {\n\t\t\t\t\tquery: message.msg,\n\t\t\t\t\tlang: apiaiLanguage\n\t\t\t\t},\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json; charset=utf-8',\n\t\t\t\t\t'Authorization': 'Bearer ' + apiaiKey\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (response.data && response.data.status.code === 200 && !_.isEmpty(response.data.result.fulfillment.speech)) {\n\t\t\t\tRocketChat.models.LivechatExternalMessage.insert({\n\t\t\t\t\trid: message.rid,\n\t\t\t\t\tmsg: response.data.result.fulfillment.speech,\n\t\t\t\t\torig: message._id,\n\t\t\t\t\tts: new Date()\n\t\t\t\t});\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tSystemLogger.error('Error using Api.ai ->', e);\n\t\t}\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'externalWebHook');\n","RocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\t// check if room is yet awaiting for response\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.waitingResponse)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent by the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\tlet now = new Date();\n\t\tRocketChat.models.Rooms.setResponseByRoomId(room._id, {\n\t\t\tuser: {\n\t\t\t\t_id: message.u._id,\n\t\t\t\tusername: message.u.username\n\t\t\t},\n\t\t\tresponseDate: now,\n\t\t\tresponseTime: (now.getTime() - room.ts) / 1000\n\t\t});\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'markRoomResponded');\n","RocketChat.callbacks.add('livechat.offlineMessage', (data) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_offline_msg')) {\n\t\treturn data;\n\t}\n\n\tlet postData = {\n\t\ttype: 'LivechatOfflineMessage',\n\t\tsentAt: new Date(),\n\t\tvisitor: {\n\t\t\tname: data.name,\n\t\t\temail: data.email\n\t\t},\n\t\tmessage: data.message\n\t};\n\n\tRocketChat.Livechat.sendRequest(postData);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-email-offline-message');\n","function sendToCRM(hook, room) {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_close')) {\n\t\treturn room;\n\t}\n\n\tlet postData = RocketChat.Livechat.getLivechatRoomGuestInfo(room);\n\tif (hook === 'closeRoom') {\n\t\tpostData.type = 'LivechatSession';\n\t} else if (hook === 'saveLivechatInfo') {\n\t\tpostData.type = 'LivechatEdit';\n\t}\n\n\tpostData.messages = [];\n\n\tRocketChat.models.Messages.findVisibleByRoomId(room._id, { sort: { ts: 1 } }).forEach((message) => {\n\t\tif (message.t) {\n\t\t\treturn;\n\t\t}\n\t\tlet msg = {\n\t\t\tusername: message.u.username,\n\t\t\tmsg: message.msg,\n\t\t\tts: message.ts\n\t\t};\n\n\t\tif (message.u.username !== postData.visitor.username) {\n\t\t\tmsg.agentId = message.u._id;\n\t\t}\n\t\tpostData.messages.push(msg);\n\t});\n\n\tconst response = RocketChat.Livechat.sendRequest(postData);\n\n\tif (response && response.data && response.data.data) {\n\t\tRocketChat.models.Rooms.saveCRMDataByRoomId(room._id, response.data.data);\n\t}\n\n\treturn room;\n}\n\nRocketChat.callbacks.add('livechat.closeRoom', (room) => {\n\treturn sendToCRM('closeRoom', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-close-room');\n\nRocketChat.callbacks.add('livechat.saveInfo', (room) => {\n\treturn sendToCRM('saveLivechatInfo', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-save-info');\n","Meteor.methods({\n\t'livechat:addAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addAgent(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:addManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addManager(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:changeLivechatStatus'() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:changeLivechatStatus' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tlet newStatus = user.statusLivechat === 'available' ? 'not-available' : 'available';\n\n\t\treturn RocketChat.models.Users.setLivechatStatus(user._id, newStatus);\n\t}\n});\n","Meteor.methods({\n\t'livechat:closeByVisitor'() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeByVisitor' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneOpenByVisitorId(Meteor.userId());\n\n\t\tif (!room || !room.open) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tlet language = (user && user.language) || RocketChat.settings.get('language') || 'en';\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tuser: user,\n\t\t\troom: room,\n\t\t\tcomment: TAPi18n.__('Closed_by_visitor', { lng: language })\n\t\t});\n\t}\n});\n","Meteor.methods({\n\t'livechat:closeRoom'(roomId, comment) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'close-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\t\tconst user = Meteor.user();\n\n\t\tif (room.usernames.indexOf(user.username) === -1 && !RocketChat.authz.hasPermission(Meteor.userId(), 'close-others-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tuser: user,\n\t\t\troom: room,\n\t\t\tcomment: comment\n\t\t});\n\t}\n});\n","Meteor.methods({\n\t'livechat:getCustomFields'() {\n\t\treturn RocketChat.models.LivechatCustomField.find().fetch();\n\t}\n});\n","Meteor.methods({\n\t'livechat:getInitialData'(visitorToken) {\n\t\tvar info = {\n\t\t\tenabled: null,\n\t\t\ttitle: null,\n\t\t\tcolor: null,\n\t\t\tregistrationForm: null,\n\t\t\troom: null,\n\t\t\ttriggers: [],\n\t\t\tdepartments: [],\n\t\t\tonline: true,\n\t\t\tofflineColor: null,\n\t\t\tofflineMessage: null,\n\t\t\tofflineSuccessMessage: null,\n\t\t\tofflineUnavailableMessage: null,\n\t\t\tdisplayOfflineForm: null,\n\t\t\tvideoCall: null\n\t\t};\n\n\t\tconst room = RocketChat.models.Rooms.findOpenByVisitorToken(visitorToken, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tt: 1,\n\t\t\t\tcl: 1,\n\t\t\t\tu: 1,\n\t\t\t\tusernames: 1,\n\t\t\t\tv: 1\n\t\t\t}\n\t\t}).fetch();\n\n\t\tif (room && room.length > 0) {\n\t\t\tinfo.room = room[0];\n\t\t}\n\n\t\tconst initSettings = RocketChat.Livechat.getInitSettings();\n\n\t\tinfo.title = initSettings.Livechat_title;\n\t\tinfo.color = initSettings.Livechat_title_color;\n\t\tinfo.enabled = initSettings.Livechat_enabled;\n\t\tinfo.registrationForm = initSettings.Livechat_registration_form;\n\t\tinfo.offlineTitle = initSettings.Livechat_offline_title;\n\t\tinfo.offlineColor = initSettings.Livechat_offline_title_color;\n\t\tinfo.offlineMessage = initSettings.Livechat_offline_message;\n\t\tinfo.offlineSuccessMessage = initSettings.Livechat_offline_success_message;\n\t\tinfo.offlineUnavailableMessage = initSettings.Livechat_offline_form_unavailable;\n\t\tinfo.displayOfflineForm = initSettings.Livechat_display_offline_form;\n\t\tinfo.language = initSettings.Language;\n\t\tinfo.videoCall = initSettings.Livechat_videocall_enabled === true && initSettings.Jitsi_Enabled === true;\n\t\tinfo.transcript = initSettings.Livechat_enable_transcript;\n\t\tinfo.transcriptMessage = initSettings.Livechat_transcript_message;\n\n\n\t\tRocketChat.models.LivechatTrigger.find().forEach((trigger) => {\n\t\t\tinfo.triggers.push(trigger);\n\t\t});\n\n\t\tRocketChat.models.LivechatDepartment.findEnabledWithAgents().forEach((department) => {\n\t\t\tinfo.departments.push(department);\n\t\t});\n\n\t\tinfo.online = RocketChat.models.Users.findOnlineAgents().count() > 0;\n\n\t\treturn info;\n\t}\n});\n","Meteor.methods({\n\t'livechat:loginByToken'(token) {\n\t\tconst user = RocketChat.models.Users.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst stampedToken = Accounts._generateStampedLoginToken();\n\t\tconst hashStampedToken = Accounts._hashStampedToken(stampedToken);\n\n\t\tlet updateUser = {\n\t\t\t$set: {\n\t\t\t\tservices: {\n\t\t\t\t\tresume: {\n\t\t\t\t\t\tloginTokens: [ hashStampedToken ]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tMeteor.users.update(user._id, updateUser);\n\n\t\treturn {\n\t\t\ttoken: stampedToken.token\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'livechat:pageVisited'(token, pageInfo) {\n\t\treturn RocketChat.Livechat.savePageHistory(token, pageInfo);\n\t}\n});\n","Meteor.methods({\n\t'livechat:registerGuest': function({ token, name, email, department } = {}) {\n\t\tvar stampedToken = Accounts._generateStampedLoginToken();\n\t\tvar hashStampedToken = Accounts._hashStampedToken(stampedToken);\n\n\t\tlet userId = RocketChat.Livechat.registerGuest.call(this, {\n\t\t\ttoken: token,\n\t\t\tname: name,\n\t\t\temail: email,\n\t\t\tdepartment: department,\n\t\t\tloginToken: hashStampedToken\n\t\t});\n\n\t\t// update visited page history to not expire\n\t\tRocketChat.models.LivechatPageVisited.keepHistoryForToken(token);\n\n\t\treturn {\n\t\t\tuserId: userId,\n\t\t\ttoken: stampedToken.token\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeAgent(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeCustomField'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\tcheck(_id, String);\n\n\t\tvar customField = RocketChat.models.LivechatCustomField.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!customField) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom field not found', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.removeById(_id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeDepartment'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeDepartment(_id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeManager(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeTrigger'(/*trigger*/) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeTrigger' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatTrigger.removeAll();\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveCustomField'(_id, customFieldData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tcheck(_id, String);\n\t\t}\n\n\t\tcheck(customFieldData, Match.ObjectIncluding({ field: String, label: String, scope: String, visibility: String }));\n\n\t\tif (!/^[0-9a-zA-Z-_]+$/.test(customFieldData.field)) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field-nmae', 'Invalid custom field name. Use only letters, numbers, hyphens and underscores.', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(_id);\n\t\t\tif (!customField) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom Field Not found', { method: 'livechat:saveCustomField' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.createOrUpdateCustomField(_id, customFieldData.field, customFieldData.label, customFieldData.scope, customFieldData.visibility);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveDepartment'(_id, departmentData, departmentAgents) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.saveDepartment(_id, departmentData, departmentAgents);\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveInfo': function(guestData, roomData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tcheck(guestData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\tname: Match.Optional(String),\n\t\t\temail: Match.Optional(String),\n\t\t\tphone: Match.Optional(String)\n\t\t}));\n\n\t\tcheck(roomData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\ttopic: Match.Optional(String),\n\t\t\ttags: Match.Optional(String)\n\t\t}));\n\n\t\tconst ret = RocketChat.Livechat.saveGuest(guestData) && RocketChat.Livechat.saveRoomInfo(roomData, guestData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveInfo', RocketChat.models.Rooms.findOneById(roomData._id));\n\t\t});\n\n\t\treturn ret;\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveIntegration'(values) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveIntegration' });\n\t\t}\n\n\t\tif (typeof values['Livechat_webhookUrl'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhookUrl', s.trim(values['Livechat_webhookUrl']));\n\t\t}\n\n\t\tif (typeof values['Livechat_secret_token'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_secret_token', s.trim(values['Livechat_secret_token']));\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_close'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_close', !!values['Livechat_webhook_on_close']);\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_offline_msg'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_offline_msg', !!values['Livechat_webhook_on_offline_msg']);\n\t\t}\n\n\t\treturn;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\"]}] */\n\nMeteor.methods({\n\t'livechat:saveSurveyFeedback'(visitorToken, visitorRoom, formData) {\n\t\tcheck(visitorToken, String);\n\t\tcheck(visitorRoom, String);\n\t\tcheck(formData, [Match.ObjectIncluding({ name: String, value: String })]);\n\n\t\tconst visitor = RocketChat.models.Users.getVisitorByToken(visitorToken);\n\t\tconst room = RocketChat.models.Rooms.findOneById(visitorRoom);\n\n\t\tif (visitor !== undefined && room !== undefined && room.v !== undefined && visitor.profile !== undefined && room.v.token === visitor.profile.token) {\n\t\t\tconst updateData = {};\n\t\t\tfor (var item of formData) {\n\t\t\t\tif (_.contains(['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'], item.name) && _.contains(['1', '2', '3', '4', '5'], item.value)) {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t} else if (item.name === 'additionalFeedback') {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!_.isEmpty(updateData)) {\n\t\t\t\treturn RocketChat.models.Rooms.updateSurveyFeedbackById(room._id, updateData);\n\t\t\t}\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveTrigger'(trigger) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveTrigger' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatTrigger.save(trigger);\n\t}\n});\n","Meteor.methods({\n\t'livechat:searchAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tif (!username || !_.isString(username)) {\n\t\t\tthrow new Meteor.Error('error-invalid-arguments', 'Invalid arguments', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tvar user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\treturn user;\n\t}\n});\n","Meteor.methods({\n\tsendMessageLivechat: function(message) {\n\t\tvar guest;\n\n\t\tcheck(message.rid, String);\n\t\tcheck(message.token, String);\n\n\t\tguest = Meteor.users.findOne(Meteor.userId(), {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tdepartment: 1\n\t\t\t}\n\t\t});\n\n\t\treturn RocketChat.Livechat.sendMessage({ guest: guest, message: message });\n\t}\n});\n","/* globals DDPRateLimiter */\nMeteor.methods({\n\t'livechat:sendOfflineMessage'(data) {\n\t\tcheck(data, {\n\t\t\tname: String,\n\t\t\temail: String,\n\t\t\tmessage: String\n\t\t});\n\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\t\tconst message = (data.message + '').replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1' + '<br>' + '$2');\n\n\t\tconst html = `\n\t\t\t<h1>New livechat message</h1>\n\t\t\t<p><strong>Visitor name:</strong> ${data.name}</p>\n\t\t\t<p><strong>Visitor email:</strong> ${data.email}</p>\n\t\t\t<p><strong>Message:</strong><br>${message}</p>`;\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tEmail.send({\n\t\t\t\tto: RocketChat.settings.get('Livechat_offline_email'),\n\t\t\t\tfrom: `${data.name} - ${data.email} <${fromEmail}>`,\n\t\t\t\treplyTo: `${data.name} <${data.email}>`,\n\t\t\t\tsubject: `Livechat offline message from ${data.name}: ${(data.message + '').substring(0, 20)}`,\n\t\t\t\thtml: header + html + footer\n\t\t\t});\n\t\t});\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.offlineMessage', data);\n\t\t});\n\n\t\treturn true;\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendOfflineMessage',\n\tconnectionId() {\n\t\treturn true;\n\t}\n}, 1, 5000);\n","Meteor.methods({\n\t'livechat:setCustomField'(token, key, value) {\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(key);\n\t\tif (customField) {\n\t\t\tif (customField.scope === 'room') {\n\t\t\t\treturn RocketChat.models.Rooms.updateLivechatDataByToken(token, key, value);\n\t\t\t} else {\n\t\t\t\t// Save in user\n\t\t\t\treturn RocketChat.models.Users.updateLivechatDataByToken(token, key, value);\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"MD5\"]}] */\nMeteor.methods({\n\t'livechat:startVideoCall'(roomId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeByVisitor' });\n\t\t}\n\n\t\tconst guest = Meteor.user();\n\n\t\tlet message = {\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId || Random.id(),\n\t\t\tmsg: '',\n\t\t\tts: new Date()\n\t\t};\n\n\t\tlet { room } = RocketChat.Livechat.getRoom(guest, message, { jitsiTimeout: new Date(Date.now() + 3600 * 1000) });\n\t\tmessage.rid = room._id;\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('livechat_video_call', room._id, '', guest, {\n\t\t\tactionLinks: [\n\t\t\t\t{ icon: 'icon-videocam', i18nLabel: 'Accept', method_id: 'createLivechatCall', params: '' },\n\t\t\t\t{ icon: 'icon-cancel', i18nLabel: 'Decline', method_id: 'denyLivechatCall', params: '' }\n\t\t\t]\n\t\t});\n\n\t\treturn {\n\t\t\troomId: room._id,\n\t\t\tdomain: RocketChat.settings.get('Jitsi_Domain'),\n\t\t\tjitsiRoom: 'RocketChat' + CryptoJS.MD5(RocketChat.settings.get('uniqueID') + roomId).toString()\n\t\t};\n\t}\n});\n\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.Optional\"]}] */\nMeteor.methods({\n\t'livechat:transfer'(transferData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:transfer' });\n\t\t}\n\n\t\tcheck(transferData, {\n\t\t\troomId: String,\n\t\t\tuserId: Match.Optional(String),\n\t\t\tdeparmentId: Match.Optional(String)\n\t\t});\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(transferData.roomId);\n\n\t\tconst guest = RocketChat.models.Users.findOneById(room.v._id);\n\n\t\tconst user = Meteor.user();\n\n\t\tif (room.usernames.indexOf(user.username) === -1) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:transfer' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.transfer(room, guest, transferData);\n\t}\n});\n","/* globals HTTP */\nconst postCatchError = Meteor.wrapAsync(function(url, options, resolve) {\n\tHTTP.post(url, options, function(err, res) {\n\t\tif (err) {\n\t\t\tresolve(null, err.response);\n\t\t} else {\n\t\t\tresolve(null, res);\n\t\t}\n\t});\n});\n\nMeteor.methods({\n\t'livechat:webhookTest'() {\n\t\tthis.unblock();\n\n\t\tconst sampleData = {\n\t\t\ttype: 'LivechatSession',\n\t\t\t_id: 'fasd6f5a4sd6f8a4sdf',\n\t\t\tlabel: 'title',\n\t\t\ttopic: 'asiodojf',\n\t\t\tcode: 123123,\n\t\t\tcreatedAt: new Date(),\n\t\t\tlastMessageAt: new Date(),\n\t\t\ttags: [\n\t\t\t\t'tag1',\n\t\t\t\t'tag2',\n\t\t\t\t'tag3'\n\t\t\t],\n\t\t\tcustomFields: {\n\t\t\t\tproductId: '123456'\n\t\t\t},\n\t\t\tvisitor: {\n\t\t\t\t_id: '',\n\t\t\t\tname: 'visitor name',\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tdepartment: 'department',\n\t\t\t\temail: 'email@address.com',\n\t\t\t\tphone: '192873192873',\n\t\t\t\tip: '123.456.7.89',\n\t\t\t\tbrowser: 'Chrome',\n\t\t\t\tos: 'Linux',\n\t\t\t\tcustomFields: {\n\t\t\t\t\tcustomerId: '123456'\n\t\t\t\t}\n\t\t\t},\n\t\t\tagent: {\n\t\t\t\t_id: 'asdf89as6df8',\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tname: 'Agent Name',\n\t\t\t\temail: 'agent@email.com'\n\t\t\t},\n\t\t\tmessages: [{\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tmsg: 'message content',\n\t\t\t\tts: new Date()\n\t\t\t}, {\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tagentId: 'asdf89as6df8',\n\t\t\t\tmsg: 'message content from agent',\n\t\t\t\tts: new Date()\n\t\t\t}]\n\t\t};\n\n\t\tlet options = {\n\t\t\theaders: {\n\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token')\n\t\t\t},\n\t\t\tdata: sampleData\n\t\t};\n\n\t\tlet response = postCatchError(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\n\t\tconsole.log('response ->', response);\n\n\t\tif (response && response.statusCode && response.statusCode === 200) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\tthrow new Meteor.Error('error-invalid-webhook-response');\n\t\t}\n\t}\n});\n\n","Meteor.methods({\n\t'livechat:takeInquiry'(inquiryId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst inquiry = RocketChat.models.LivechatInquiry.findOneById(inquiryId);\n\n\t\tif (!inquiry || inquiry.status === 'taken') {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Inquiry already taken', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneById(Meteor.userId());\n\n\t\tconst agent = {\n\t\t\tagentId: user._id,\n\t\t\tusername: user.username\n\t\t};\n\n\t\t// add subscription\n\t\tvar subscriptionData = {\n\t\t\trid: inquiry.rid,\n\t\t\tname: inquiry.name,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tcode: inquiry.code,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all'\n\t\t};\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\t// update room\n\t\tconst room = RocketChat.models.Rooms.findOneById(inquiry.rid);\n\t\tconst usernames = room.usernames.concat(agent.username);\n\n\t\tRocketChat.models.Rooms.changeAgentByRoomId(inquiry.rid, usernames, agent);\n\n\t\troom.usernames = usernames;\n\t\troom.servedBy = {\n\t\t\t_id: agent.agentId,\n\t\t\tusername: agent.username\n\t\t};\n\n\t\t// mark inquiry as taken\n\t\tRocketChat.models.LivechatInquiry.takeInquiry(inquiry._id);\n\n\t\t// return room corresponding to inquiry (for redirecting agent to the room route)\n\t\treturn room;\n\t}\n});\n","Meteor.methods({\n\t'livechat:returnAsInquiry'(rid) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\t// //delete agent and room subscription\n\t\tRocketChat.models.Subscriptions.removeByRoomId(rid);\n\n\t\t// remove user from room\n\t\tvar username = Meteor.user().username;\n\n\t\tRocketChat.models.Rooms.removeUsernameById(rid, username);\n\n\t\t// find inquiry corresponding to room\n\t\tvar inquiry = RocketChat.models.LivechatInquiry.findOne({rid: rid});\n\n\t\t// mark inquiry as open\n\t\treturn RocketChat.models.LivechatInquiry.openInquiry(inquiry._id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveOfficeHours'(day, start, finish, open) {\n\t\tRocketChat.models.LivechatOfficeHour.updateHours(day, start, finish, open);\n\t}\n});","/* globals emailSettings, DDPRateLimiter */\n/* Send a transcript of the room converstation to the given email */\nMeteor.methods({\n\t'livechat:sendTranscript'(rid, email) {\n\t\tcheck(rid, String);\n\t\tcheck(email, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\t\tconst user = Meteor.user();\n\t\tconst userLanguage = user.language || RocketChat.settings.get('language') || 'en';\n\n\t\t// allow to only user to send transcripts from their own chats\n\t\tif (!room || room.t !== 'l' || !room.v || !user.profile || room.v.token !== user.profile.token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tconst messages = RocketChat.models.Messages.findVisibleByRoomId(rid, { sort: { 'ts' : 1 }});\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\t\tvar html = '<div> <hr>';\n\t\tmessages.forEach(message => {\n\t\t\tif (message.t && ['command', 'livechat-close', 'livechat_video_call'].indexOf(message.t) !== -1) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar author;\n\t\t\tif (message.u._id === Meteor.userId()) {\n\t\t\t\tauthor = TAPi18n.__('You', { lng: userLanguage });\n\t\t\t} else {\n\t\t\t\tauthor = message.u.username;\n\t\t\t}\n\n\t\t\tvar datetime = moment(message.ts).locale(userLanguage).format('LLL');\n\t\t\tvar singleMessage = `\n\t\t\t\t<p><strong>${author}</strong>  <em>${datetime}</em></p>\n\t\t\t\t<p>${message.msg}</p>\n\t\t\t`;\n\t\t\thtml = html + singleMessage;\n\t\t});\n\n\t\thtml = html + '</div>';\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\temailSettings = {\n\t\t\tto: email,\n\t\t\tfrom: fromEmail,\n\t\t\treplyTo: fromEmail,\n\t\t\tsubject: TAPi18n.__('Transcript_of_your_livechat_conversation', { lng: userLanguage }),\n\t\t\thtml: header + html + footer\n\t\t};\n\n\t\tMeteor.defer(() => {\n\t\t\tEmail.send(emailSettings);\n\t\t});\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.sendTranscript', messages, email);\n\t\t});\n\n\t\treturn true;\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendTranscript',\n\tconnectionId() {\n\t\treturn true;\n\t}\n}, 1, 5000);\n","/**\n * Sets an user as (non)operator\n * @param {string} _id - User's _id\n * @param {boolean} operator - Flag to set as operator or not\n */\nRocketChat.models.Users.setOperator = function(_id, operator) {\n\tvar update = {\n\t\t$set: {\n\t\t\toperator: operator\n\t\t}\n\t};\n\n\treturn this.update(_id, update);\n};\n\n/**\n * Gets all online agents\n * @return\n */\nRocketChat.models.Users.findOnlineAgents = function() {\n\tvar query = {\n\t\tstatusConnection: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Gets all agents\n * @return\n */\nRocketChat.models.Users.findAgents = function() {\n\tvar query = {\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Find online users from a list\n * @param {array} userList - array of usernames\n * @return\n */\nRocketChat.models.Users.findOnlineUserFromList = function(userList) {\n\tvar query = {\n\t\tstatusConnection: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent',\n\t\tusername: {\n\t\t\t$in: [].concat(userList)\n\t\t}\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Get next user agent in order\n * @return {object} User from db\n */\nRocketChat.models.Users.getNextAgent = function() {\n\tvar query = {\n\t\tstatusConnection: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\tvar collectionObj = this.model.rawCollection();\n\tvar findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\tvar sort = {\n\t\tlivechatCount: 1,\n\t\tusername: 1\n\t};\n\n\tvar update = {\n\t\t$inc: {\n\t\t\tlivechatCount: 1\n\t\t}\n\t};\n\n\tvar user = findAndModify(query, sort, update);\n\tif (user && user.value) {\n\t\treturn {\n\t\t\tagentId: user.value._id,\n\t\t\tusername: user.value.username\n\t\t};\n\t} else {\n\t\treturn null;\n\t}\n};\n\n/**\n * Gets visitor by token\n * @param {string} token - Visitor token\n */\nRocketChat.models.Users.getVisitorByToken = function(token, options) {\n\tvar query = {\n\t\t'profile.guest': true,\n\t\t'profile.token': token\n\t};\n\n\treturn this.findOne(query, options);\n};\n\n/**\n * Gets visitor by token\n * @param {string} token - Visitor token\n */\nRocketChat.models.Users.findVisitorByToken = function(token) {\n\tvar query = {\n\t\t'profile.guest': true,\n\t\t'profile.token': token\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Change user's livechat status\n * @param {string} token - Visitor token\n */\nRocketChat.models.Users.setLivechatStatus = function(userId, status) {\n\tlet query = {\n\t\t'_id': userId\n\t};\n\n\tlet update = {\n\t\t$set: {\n\t\t\t'statusLivechat': status\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\n/**\n * change all livechat agents livechat status to \"not-available\"\n */\nRocketChat.models.Users.closeOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'not-available');\n\t});\n};\n\n/**\n * change all livechat agents livechat status to \"available\"\n */\nRocketChat.models.Users.openOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'available');\n\t});\n};\n\nRocketChat.models.Users.updateLivechatDataByToken = function(token, key, value) {\n\tconst query = {\n\t\t'profile.token': token\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\t[`livechatData.${key}`]: value\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\n/**\n * Find a visitor by their phone number\n * @return {object} User from db\n */\nRocketChat.models.Users.findOneVisitorByPhone = function(phone) {\n\tconst query = {\n\t\t'phone.phoneNumber': phone\n\t};\n\n\treturn this.findOne(query);\n};\n\n/**\n * Get the next visitor name\n * @return {string} The next visitor name\n */\nRocketChat.models.Users.getNextVisitorUsername = function() {\n\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\tconst query = {\n\t\t_id: 'Livechat_guest_count'\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tvalue: 1\n\t\t}\n\t};\n\n\tconst livechatCount = findAndModify(query, null, update);\n\n\treturn 'guest-' + (livechatCount.value.value + 1);\n};\n","/**\n * Gets visitor by token\n * @param {string} token - Visitor token\n */\nRocketChat.models.Rooms.updateSurveyFeedbackById = function(_id, surveyFeedback) {\n\tconst query = {\n\t\t_id: _id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tsurveyFeedback: surveyFeedback\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.updateLivechatDataByToken = function(token, key, value) {\n\tconst query = {\n\t\t'v.token': token,\n\t\topen: true\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\t[`livechatData.${key}`]: value\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.findLivechat = function(filter = {}, offset = 0, limit = 20) {\n\tconst query = _.extend(filter, {\n\t\tt: 'l'\n\t});\n\n\treturn this.find(query, { sort: { ts: - 1 }, offset: offset, limit: limit });\n};\n\nRocketChat.models.Rooms.findLivechatByCode = function(code, fields) {\n\tcode = parseInt(code);\n\n\tlet options = {};\n\n\tconst query = {\n\t\tt: 'l',\n\t\tcode: code\n\t};\n\n\tif (fields) {\n\t\toptions.fields = fields;\n\t}\n\n\treturn this.find(query, options);\n};\n\n/**\n * Get the next visitor name\n * @return {string} The next visitor name\n */\nRocketChat.models.Rooms.getNextLivechatRoomCode = function() {\n\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\tconst query = {\n\t\t_id: 'Livechat_Room_Count'\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tvalue: 1\n\t\t}\n\t};\n\n\tconst livechatCount = findAndModify(query, null, update);\n\n\treturn livechatCount.value.value;\n};\n\nRocketChat.models.Rooms.findOpenByVisitorToken = function(visitorToken, options) {\n\tconst query = {\n\t\topen: true,\n\t\t'v.token': visitorToken\n\t};\n\n\treturn this.find(query, options);\n};\n\nRocketChat.models.Rooms.findByVisitorToken = function(visitorToken) {\n\tconst query = {\n\t\t'v.token': visitorToken\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findByVisitorId = function(visitorId) {\n\tconst query = {\n\t\t'v._id': visitorId\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findOneOpenByVisitorId = function(visitorId) {\n\tconst query = {\n\t\topen: true,\n\t\t'v._id': visitorId\n\t};\n\n\treturn this.findOne(query);\n};\n\nRocketChat.models.Rooms.setResponseByRoomId = function(roomId, response) {\n\treturn this.update({\n\t\t_id: roomId\n\t}, {\n\t\t$set: {\n\t\t\tresponseBy: {\n\t\t\t\t_id: response.user._id,\n\t\t\t\tusername: response.user.username\n\t\t\t},\n\t\t\tresponseDate: response.responseDate,\n\t\t\tresponseTime: response.responseTime\n\t\t},\n\t\t$unset: {\n\t\t\twaitingResponse: 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Rooms.closeByRoomId = function(roomId, closeInfo) {\n\treturn this.update({\n\t\t_id: roomId\n\t}, {\n\t\t$set: {\n\t\t\tclosedBy: {\n\t\t\t\t_id: closeInfo.user._id,\n\t\t\t\tusername: closeInfo.user.username\n\t\t\t},\n\t\t\tclosedAt: closeInfo.closedAt,\n\t\t\tchatDuration: closeInfo.chatDuration\n\t\t},\n\t\t$unset: {\n\t\t\topen: 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Rooms.setLabelByRoomId = function(roomId, label) {\n\treturn this.update({ _id: roomId }, { $set: { label: label } });\n};\n\nRocketChat.models.Rooms.findOpenByAgent = function(userId) {\n\tconst query = {\n\t\topen: true,\n\t\t'servedBy._id': userId\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.changeAgentByRoomId = function(roomId, newUsernames, newAgent) {\n\tconst query = {\n\t\t_id: roomId\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tusernames: newUsernames,\n\t\t\tservedBy: {\n\t\t\t\t_id: newAgent.agentId,\n\t\t\t\tusername: newAgent.username\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.update(query, update);\n};\n\nRocketChat.models.Rooms.saveCRMDataByRoomId = function(roomId, crmData) {\n\tconst query = {\n\t\t_id: roomId\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tcrmData\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n","class LivechatExternalMessage extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_external_message');\n\t}\n\n\t// FIND\n\tfindByRoomId(roomId, sort = { ts: -1 }) {\n\t\tconst query = { rid: roomId };\n\n\t\treturn this.find(query, { sort: sort });\n\t}\n}\n\nRocketChat.models.LivechatExternalMessage = new LivechatExternalMessage();\n","/**\n * Livechat Custom Fields model\n */\nclass LivechatCustomField extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_custom_field');\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id: _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tcreateOrUpdateCustomField(_id, field, label, scope, visibility, extraData) {\n\t\tvar record = {\n\t\t\tlabel: label,\n\t\t\tscope: scope,\n\t\t\tvisibility: visibility\n\t\t};\n\n\t\t_.extend(record, extraData);\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id: _id }, { $set: record });\n\t\t} else {\n\t\t\trecord._id = field;\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\treturn record;\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id: _id };\n\n\t\treturn this.remove(query);\n\t}\n}\n\nRocketChat.models.LivechatCustomField = new LivechatCustomField();\n","/**\n * Livechat Department model\n */\nclass LivechatDepartment extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department');\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id: _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tfindByDepartmentId(_id, options) {\n\t\tconst query = { _id: _id };\n\n\t\treturn this.find(query, options);\n\t}\n\n\tcreateOrUpdateDepartment(_id, enabled, name, description, agents, extraData) {\n\t\tagents = [].concat(agents);\n\n\t\tvar record = {\n\t\t\tenabled: enabled,\n\t\t\tname: name,\n\t\t\tdescription: description,\n\t\t\tnumAgents: agents.length\n\t\t};\n\n\t\t_.extend(record, extraData);\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id: _id }, { $set: record });\n\t\t} else {\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\tvar savedAgents = _.pluck(RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(_id).fetch(), 'agentId');\n\t\tvar agentsToSave = _.pluck(agents, 'agentId');\n\n\t\t// remove other agents\n\t\t_.difference(savedAgents, agentsToSave).forEach((agentId) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.removeByDepartmentIdAndAgentId(_id, agentId);\n\t\t});\n\n\t\tagents.forEach((agent) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.saveAgent({\n\t\t\t\tagentId: agent.agentId,\n\t\t\t\tdepartmentId: _id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: agent.count ? parseInt(agent.count) : 0,\n\t\t\t\torder: agent.order ? parseInt(agent.order) : 0\n\t\t\t});\n\t\t});\n\n\t\treturn _.extend(record, { _id: _id });\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id: _id };\n\n\t\treturn this.remove(query);\n\t}\n\n\tfindEnabledWithAgents() {\n\t\tvar query = {\n\t\t\tnumAgents: { $gt: 0 },\n\t\t\tenabled: true\n\t\t};\n\t\treturn this.find(query);\n\t}\n}\n\nRocketChat.models.LivechatDepartment = new LivechatDepartment();\n","/**\n * Livechat Department model\n */\nclass LivechatDepartmentAgents extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department_agents');\n\t}\n\n\tfindByDepartmentId(departmentId) {\n\t\treturn this.find({ departmentId: departmentId });\n\t}\n\n\tsaveAgent(agent) {\n\t\treturn this.upsert({\n\t\t\tagentId: agent.agentId,\n\t\t\tdepartmentId: agent.departmentId\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: parseInt(agent.count),\n\t\t\t\torder: parseInt(agent.order)\n\t\t\t}\n\t\t});\n\t}\n\n\tremoveByDepartmentIdAndAgentId(departmentId, agentId) {\n\t\tthis.remove({ departmentId: departmentId, agentId: agentId });\n\t}\n\n\tgetNextAgentForDepartment(departmentId) {\n\t\tvar agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tvar onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tvar query = {\n\t\t\tdepartmentId: departmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames\n\t\t\t}\n\t\t};\n\n\t\tvar sort = {\n\t\t\tcount: 1,\n\t\t\torder: 1,\n\t\t\tusername: 1\n\t\t};\n\t\tvar update = {\n\t\t\t$inc: {\n\t\t\t\tcount: 1\n\t\t\t}\n\t\t};\n\n\t\tvar collectionObj = this.model.rawCollection();\n\t\tvar findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\t\tvar agent = findAndModify(query, sort, update);\n\t\tif (agent && agent.value) {\n\t\t\treturn {\n\t\t\t\tagentId: agent.value.agentId,\n\t\t\t\tusername: agent.value.username\n\t\t\t};\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tgetOnlineForDepartment(departmentId) {\n\t\tvar agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tvar onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tvar query = {\n\t\t\tdepartmentId: departmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames\n\t\t\t}\n\t\t};\n\n\t\tvar depAgents = this.find(query);\n\n\t\tif (depAgents) {\n\t\t\treturn depAgents;\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tfindUsersInQueue(usersList) {\n\t\tlet query = {};\n\n\t\tif (!_.isEmpty(usersList)) {\n\t\t\tquery.username = {\n\t\t\t\t$in: usersList\n\t\t\t};\n\t\t}\n\n\t\tlet options = {\n\t\t\tsort: {\n\t\t\t\tdepartmentId: 1,\n\t\t\t\tcount: 1,\n\t\t\t\torder: 1,\n\t\t\t\tusername: 1\n\t\t\t}\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n}\n\nRocketChat.models.LivechatDepartmentAgents = new LivechatDepartmentAgents();\n","/**\n * Livechat Page Visited model\n */\nclass LivechatPageVisited extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_page_visited');\n\n\t\tthis.tryEnsureIndex({ 'token': 1 });\n\t\tthis.tryEnsureIndex({ 'ts': 1 });\n\n\t\t// keep history for 1 month if the visitor does not register\n\t\tthis.tryEnsureIndex({ 'expireAt': 1 }, { sparse: 1, expireAfterSeconds: 0 });\n\t}\n\n\tsaveByToken(token, pageInfo) {\n\t\t// keep history of unregistered visitors for 1 month\n\t\tvar keepHistoryMiliseconds = 2592000000;\n\n\t\treturn this.insert({\n\t\t\ttoken: token,\n\t\t\tpage: pageInfo,\n\t\t\tts: new Date(),\n\t\t\texpireAt: new Date().getTime() + keepHistoryMiliseconds\n\t\t});\n\t}\n\n\tfindByToken(token) {\n\t\treturn this.find({ token: token }, { sort : { ts: -1 }, limit: 20 });\n\t}\n\n\tkeepHistoryForToken(token) {\n\t\treturn this.update({\n\t\t\ttoken: token,\n\t\t\texpireAt: {\n\t\t\t\t$exists: true\n\t\t\t}\n\t\t}, {\n\t\t\t$unset: {\n\t\t\t\texpireAt: 1\n\t\t\t}\n\t\t}, {\n\t\t\tmulti: true\n\t\t});\n\t}\n}\n\nRocketChat.models.LivechatPageVisited = new LivechatPageVisited();\n","/**\n * Livechat Trigger model\n */\nclass LivechatTrigger extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_trigger');\n\t}\n\n\t// FIND\n\tsave(data) {\n\t\tconst trigger = this.findOne();\n\n\t\tif (trigger) {\n\t\t\treturn this.update({ _id: trigger._id }, { $set: data });\n\t\t} else {\n\t\t\treturn this.insert(data);\n\t\t}\n\t}\n\n\tremoveAll() {\n\t\tthis.remove({});\n\t}\n}\n\nRocketChat.models.LivechatTrigger = new LivechatTrigger();\n","Meteor.startup(function() {\n\tRocketChat.models.Rooms.tryEnsureIndex({ code: 1 });\n\tRocketChat.models.Rooms.tryEnsureIndex({ open: 1 }, { sparse: 1 });\n});\n","class LivechatInquiry extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_inquiry');\n\n\t\tthis.tryEnsureIndex({ 'rid': 1 }); // room id corresponding to this inquiry\n\t\tthis.tryEnsureIndex({ 'name': 1 }); // name of the inquiry (client name for now)\n\t\tthis.tryEnsureIndex({ 'message': 1 }); // message sent by the client\n\t\tthis.tryEnsureIndex({ 'ts': 1 }); // timestamp\n\t\tthis.tryEnsureIndex({ 'code': 1 }); // (for routing)\n\t\tthis.tryEnsureIndex({ 'agents': 1}); // Id's of the agents who can see the inquiry (handle departments)\n\t\tthis.tryEnsureIndex({ 'status': 1}); // 'open', 'taken'\n\t}\n\n\tfindOneById(inquiryId) {\n\t\treturn this.findOne({ _id: inquiryId });\n\t}\n\n\t/*\n\t * mark the inquiry as taken\n\t */\n\ttakeInquiry(inquiryId) {\n\t\tthis.update({\n\t\t\t'_id': inquiryId\n\t\t}, {\n\t\t\t$set: { status: 'taken' }\n\t\t});\n\t}\n\n\t/*\n\t * mark inquiry as open\n\t */\n\topenInquiry(inquiryId) {\n\t\tthis.update({\n\t\t\t'_id': inquiryId\n\t\t}, {\n\t\t\t$set: { status: 'open' }\n\t\t});\n\t}\n\n\t/*\n\t * return the status of the inquiry (open or taken)\n\t */\n\tgetStatus(inquiryId) {\n\t\treturn this.findOne({'_id': inquiryId}).status;\n\t}\n}\n\nRocketChat.models.LivechatInquiry = new LivechatInquiry();\n","class LivechatOfficeHour extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_office_hour');\n\n\t\tthis.tryEnsureIndex({ 'day': 1 }); // the day of the week monday - sunday\n\t\tthis.tryEnsureIndex({ 'start': 1 }); // the opening hours of the office\n\t\tthis.tryEnsureIndex({ 'finish': 1 }); // the closing hours of the office\n\t\tthis.tryEnsureIndex({ 'open': 1 }); // whether or not the offices are open on this day\n\n\t\t// if there is nothing in the collection, add defaults\n\t\tif (this.find().count() === 0) {\n\t\t\tthis.insert({'day' : 'Monday', 'start' : '08:00', 'finish' : '20:00', 'code' : 1, 'open' : true });\n\t\t\tthis.insert({'day' : 'Tuesday', 'start' : '08:00', 'finish' : '20:00', 'code' : 2, 'open' : true });\n\t\t\tthis.insert({'day' : 'Wednesday', 'start' : '08:00', 'finish' : '20:00', 'code' : 3, 'open' : true });\n\t\t\tthis.insert({'day' : 'Thursday', 'start' : '08:00', 'finish' : '20:00', 'code' : 4, 'open' : true });\n\t\t\tthis.insert({'day' : 'Friday', 'start' : '08:00', 'finish' : '20:00', 'code' : 5, 'open' : true });\n\t\t\tthis.insert({'day' : 'Saturday', 'start' : '08:00', 'finish' : '20:00', 'code' : 6, 'open' : false });\n\t\t\tthis.insert({'day' : 'Sunday', 'start' : '08:00', 'finish' : '20:00', 'code' : 0, 'open' : false });\n\n\t\t}\n\t}\n\n\t/*\n\t * update the given days start and finish times and whether the office is open on that day\n\t */\n\tupdateHours(day, newStart, newFinish, newOpen) {\n\t\tthis.update({\n\t\t\t'day': day\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstart: newStart,\n\t\t\t\tfinish: newFinish,\n\t\t\t\topen: newOpen\n\t\t\t}\n\t\t});\n\t}\n\n\t/*\n\t * Check if the current server time (utc) is within the office hours of that day\n\t * returns true or false\n\t */\n\tisNowWithinHours() {\n\t\t// get current time on server in utc\n\t\t// var ct = moment().utc();\n\t\tvar currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tvar todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tvar start = moment.utc(todaysOfficeHours.day + ':' + todaysOfficeHours.start, 'dddd:HH:mm');\n\t\tvar finish = moment.utc(todaysOfficeHours.day + ':' + todaysOfficeHours.finish, 'dddd:HH:mm');\n\n\t\t// console.log(finish.isBefore(start));\n\t\tif (finish.isBefore(start)) {\n\t\t\t// finish.day(finish.day()+1);\n\t\t\tfinish.add(1, 'days');\n\t\t}\n\n\t\tvar result = currentTime.isBetween(start, finish);\n\n\t\t// inBetween  check\n\t\treturn result;\n\t}\n\n\tisOpeningTime() {\n\t\t// get current time on server in utc\n\t\tvar currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tvar todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tvar start = moment.utc(todaysOfficeHours.day + ':' + todaysOfficeHours.start, 'dddd:HH:mm');\n\n\t\treturn start.isSame(currentTime, 'minute');\n\t}\n\n\tisClosingTime() {\n\t\t// get current time on server in utc\n\t\tvar currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tvar todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\tvar finish = moment.utc(todaysOfficeHours.day + ':' + todaysOfficeHours.finish, 'dddd:HH:mm');\n\n\t\treturn finish.isSame(currentTime, 'minute');\n\t}\n}\n\nRocketChat.models.LivechatOfficeHour = new LivechatOfficeHour();\n","/* globals HTTP */\nimport UAParser from 'ua-parser-js';\n\nRocketChat.Livechat = {\n\thistoryMonitorType: 'url',\n\n\tlogger: new Logger('Livechat', {\n\t\tsections: {\n\t\t\twebhook: 'Webhook'\n\t\t}\n\t}),\n\n\tgetNextAgent(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getNextAgentForDepartment(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.getNextAgent();\n\t\t}\n\t},\n\tgetAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.findAgents();\n\t\t}\n\t},\n\tgetOnlineAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getOnlineForDepartment(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.findOnlineAgents();\n\t\t}\n\t},\n\tgetRoom(guest, message, roomInfo) {\n\t\tvar room = RocketChat.models.Rooms.findOneById(message.rid);\n\t\tvar newRoom = false;\n\n\t\tif (room && !room.open) {\n\t\t\tmessage.rid = Random.id();\n\t\t\troom = null;\n\t\t}\n\n\t\tif (room == null) {\n\t\t\t// if no department selected verify if there is at least one active and choose one randomly\n\t\t\tif (!guest.department) {\n\t\t\t\tvar departments = RocketChat.models.LivechatDepartment.findEnabledWithAgents();\n\t\t\t\tif (departments.count() > 0) {\n\t\t\t\t\tguest.department = departments.fetch()[0]._id;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// delegate room creation to QueueMethods\n\t\t\tconst routingMethod = RocketChat.settings.get('Livechat_Routing_Method');\n\t\t\troom = RocketChat.QueueMethods[routingMethod](guest, message, roomInfo);\n\n\t\t\tnewRoom = true;\n\t\t} else {\n\t\t\troom = Meteor.call('canAccessRoom', message.rid, guest._id);\n\t\t}\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('cannot-acess-room');\n\t\t}\n\n\t\treturn { room, newRoom };\n\t},\n\tsendMessage({ guest, message, roomInfo }) {\n\t\tlet { room, newRoom } = this.getRoom(guest, message, roomInfo);\n\t\tif (guest.name) {\n\t\t\tmessage.alias = guest.name;\n\t\t}\n\t\treturn _.extend(RocketChat.sendMessage(guest, message, room), { newRoom: newRoom });\n\t},\n\tregisterGuest({ token, name, email, department, phone, loginToken, username } = {}) {\n\t\tcheck(token, String);\n\n\t\tlet userId;\n\t\tlet updateUser = {\n\t\t\t$set: {\n\t\t\t\tprofile: {\n\t\t\t\t\tguest: true,\n\t\t\t\t\ttoken: token\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tconst user = RocketChat.models.Users.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (user) {\n\t\t\tuserId = user._id;\n\t\t\tif (loginToken) {\n\t\t\t\tif (!updateUser.$addToSet) {\n\t\t\t\t\tupdateUser.$addToSet = {};\n\t\t\t\t}\n\t\t\t\tupdateUser.$addToSet['services.resume.loginTokens'] = loginToken;\n\t\t\t}\n\t\t} else {\n\t\t\tif (!username) {\n\t\t\t\tusername = RocketChat.models.Users.getNextVisitorUsername();\n\t\t\t}\n\n\t\t\tvar existingUser = null;\n\n\t\t\tif (s.trim(email) !== '' && (existingUser = RocketChat.models.Users.findOneByEmailAddress(email))) {\n\t\t\t\tif (existingUser.type !== 'visitor') {\n\t\t\t\t\tthrow new Meteor.Error('error-invalid-user', 'This email belongs to a registered user.');\n\t\t\t\t}\n\n\t\t\t\tupdateUser.$addToSet = {\n\t\t\t\t\tglobalRoles: 'livechat-guest'\n\t\t\t\t};\n\n\t\t\t\tif (loginToken) {\n\t\t\t\t\tupdateUser.$addToSet['services.resume.loginTokens'] = loginToken;\n\t\t\t\t}\n\n\t\t\t\tuserId = existingUser._id;\n\t\t\t} else {\n\t\t\t\tupdateUser.$set.name = name;\n\n\t\t\t\tvar userData = {\n\t\t\t\t\tusername: username,\n\t\t\t\t\tglobalRoles: ['livechat-guest'],\n\t\t\t\t\tdepartment: department,\n\t\t\t\t\ttype: 'visitor'\n\t\t\t\t};\n\n\t\t\t\tif (this.connection) {\n\t\t\t\t\tuserData.userAgent = this.connection.httpHeaders['user-agent'];\n\t\t\t\t\tuserData.ip = this.connection.httpHeaders['x-real-ip'] || this.connection.clientAddress;\n\t\t\t\t\tuserData.host = this.connection.httpHeaders.host;\n\t\t\t\t}\n\n\t\t\t\tuserId = Accounts.insertUserDoc({}, userData);\n\n\t\t\t\tif (loginToken) {\n\t\t\t\t\tupdateUser.$set.services = {\n\t\t\t\t\t\tresume: {\n\t\t\t\t\t\t\tloginTokens: [ loginToken ]\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (phone) {\n\t\t\tupdateUser.$set.phone = [\n\t\t\t\t{ phoneNumber: phone.number }\n\t\t\t];\n\t\t}\n\n\t\tif (email && email.trim() !== '') {\n\t\t\tupdateUser.$set.emails = [\n\t\t\t\t{ address: email }\n\t\t\t];\n\t\t}\n\n\t\tMeteor.users.update(userId, updateUser);\n\n\t\treturn userId;\n\t},\n\n\tsaveGuest({ _id, name, email, phone }) {\n\t\tlet updateData = {};\n\n\t\tif (name) {\n\t\t\tupdateData.name = name;\n\t\t}\n\t\tif (email) {\n\t\t\tupdateData.email = email;\n\t\t}\n\t\tif (phone) {\n\t\t\tupdateData.phone = phone;\n\t\t}\n\t\tconst ret = RocketChat.models.Users.saveUserById(_id, updateData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveGuest', updateData);\n\t\t});\n\n\t\treturn ret;\n\t},\n\n\tcloseRoom({ user, room, comment }) {\n\t\tlet now = new Date();\n\t\tRocketChat.models.Rooms.closeByRoomId(room._id, {\n\t\t\tuser: {\n\t\t\t\t_id: user._id,\n\t\t\t\tusername: user.username\n\t\t\t},\n\t\t\tclosedAt: now,\n\t\t\tchatDuration: (now.getTime() - room.ts) / 1000\n\t\t});\n\n\t\tconst message = {\n\t\t\tt: 'livechat-close',\n\t\t\tmsg: comment,\n\t\t\tgroupable: false\n\t\t};\n\n\t\tRocketChat.sendMessage(user, message, room);\n\n\t\tRocketChat.models.Subscriptions.hideByRoomIdAndUserId(room._id, user._id);\n\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('promptTranscript', room._id, user);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.closeRoom', room);\n\t\t});\n\n\t\treturn true;\n\t},\n\n\tgetInitSettings() {\n\t\tlet settings = {};\n\n\t\tRocketChat.models.Settings.findNotHiddenPublic([\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_enabled',\n\t\t\t'Livechat_registration_form',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_videocall_enabled',\n\t\t\t'Jitsi_Enabled',\n\t\t\t'Language',\n\t\t\t'Livechat_enable_transcript',\n\t\t\t'Livechat_transcript_message'\n\t\t]).forEach((setting) => {\n\t\t\tsettings[setting._id] = setting.value;\n\t\t});\n\n\t\treturn settings;\n\t},\n\n\tsaveRoomInfo(roomData, guestData) {\n\t\tif (!RocketChat.models.Rooms.saveRoomById(roomData._id, roomData)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveRoom', roomData);\n\t\t});\n\n\t\tif (!_.isEmpty(guestData.name)) {\n\t\t\treturn RocketChat.models.Rooms.setLabelByRoomId(roomData._id, guestData.name) && RocketChat.models.Subscriptions.updateNameByRoomId(roomData._id, guestData.name);\n\t\t}\n\t},\n\n\tcloseOpenChats(userId, comment) {\n\t\tconst user = RocketChat.models.Users.findOneById(userId);\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tthis.closeRoom({ user, room, comment});\n\t\t});\n\t},\n\n\tforwardOpenChats(userId) {\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tconst guest = RocketChat.models.Users.findOneById(room.v._id);\n\t\t\tthis.transfer(room, guest, { departmentId: guest.department });\n\t\t});\n\t},\n\n\tsavePageHistory(token, pageInfo) {\n\t\tif (pageInfo.change === RocketChat.Livechat.historyMonitorType) {\n\t\t\treturn RocketChat.models.LivechatPageVisited.saveByToken(token, pageInfo);\n\t\t}\n\n\t\treturn;\n\t},\n\n\ttransfer(room, guest, transferData) {\n\t\tlet agent;\n\n\t\tif (transferData.userId) {\n\t\t\tconst user = RocketChat.models.Users.findOneById(transferData.userId);\n\t\t\tagent = {\n\t\t\t\tagentId: user._id,\n\t\t\t\tusername: user.username\n\t\t\t};\n\t\t} else {\n\t\t\tagent = RocketChat.Livechat.getNextAgent(transferData.departmentId);\n\t\t}\n\n\t\tif (agent && agent.agentId !== room.servedBy._id) {\n\t\t\troom.usernames = _.without(room.usernames, room.servedBy.username).concat(agent.username);\n\n\t\t\tRocketChat.models.Rooms.changeAgentByRoomId(room._id, room.usernames, agent);\n\n\t\t\tlet subscriptionData = {\n\t\t\t\trid: room._id,\n\t\t\t\tname: guest.name || guest.username,\n\t\t\t\talert: true,\n\t\t\t\topen: true,\n\t\t\t\tunread: 1,\n\t\t\t\tcode: room.code,\n\t\t\t\tu: {\n\t\t\t\t\t_id: agent.agentId,\n\t\t\t\t\tusername: agent.username\n\t\t\t\t},\n\t\t\t\tt: 'l',\n\t\t\t\tdesktopNotifications: 'all',\n\t\t\t\tmobilePushNotifications: 'all',\n\t\t\t\temailNotifications: 'all'\n\t\t\t};\n\t\t\tRocketChat.models.Subscriptions.removeByRoomIdAndUserId(room._id, room.servedBy._id);\n\n\t\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\t\tRocketChat.models.Messages.createUserLeaveWithRoomIdAndUser(room._id, { _id: room.servedBy._id, username: room.servedBy.username });\n\t\t\tRocketChat.models.Messages.createUserJoinWithRoomIdAndUser(room._id, { _id: agent.agentId, username: agent.username });\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tsendRequest(postData, callback, trying = 1) {\n\t\ttry {\n\t\t\tlet options = {\n\t\t\t\theaders: {\n\t\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token')\n\t\t\t\t},\n\t\t\t\tdata: postData\n\t\t\t};\n\t\t\treturn HTTP.post(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\t\t} catch (e) {\n\t\t\tRocketChat.Livechat.logger.webhook.error('Response error on ' + trying + ' try ->', e);\n\t\t\t// try 10 times after 10 seconds each\n\t\t\tif (trying < 10) {\n\t\t\t\tRocketChat.Livechat.logger.webhook.warn('Will try again in 10 seconds ...');\n\t\t\t\ttrying++;\n\t\t\t\tsetTimeout(Meteor.bindEnvironment(() => {\n\t\t\t\t\tRocketChat.Livechat.sendRequest(postData, callback, trying);\n\t\t\t\t}), 10000);\n\t\t\t}\n\t\t}\n\t},\n\n\tgetLivechatRoomGuestInfo(room) {\n\t\tconst visitor = RocketChat.models.Users.findOneById(room.v._id);\n\t\tconst agent = RocketChat.models.Users.findOneById(room.servedBy._id);\n\n\t\tconst ua = new UAParser();\n\t\tua.setUA(visitor.userAgent);\n\n\t\tlet postData = {\n\t\t\t_id: room._id,\n\t\t\tlabel: room.label,\n\t\t\ttopic: room.topic,\n\t\t\tcode: room.code,\n\t\t\tcreatedAt: room.ts,\n\t\t\tlastMessageAt: room.lm,\n\t\t\ttags: room.tags,\n\t\t\tcustomFields: room.livechatData,\n\t\t\tvisitor: {\n\t\t\t\t_id: visitor._id,\n\t\t\t\tname: visitor.name,\n\t\t\t\tusername: visitor.username,\n\t\t\t\temail: null,\n\t\t\t\tphone: null,\n\t\t\t\tdepartment: visitor.department,\n\t\t\t\tip: visitor.ip,\n\t\t\t\tos: ua.getOS().name && (ua.getOS().name + ' ' + ua.getOS().version),\n\t\t\t\tbrowser: ua.getBrowser().name && (ua.getBrowser().name + ' ' + ua.getBrowser().version),\n\t\t\t\tcustomFields: visitor.livechatData\n\t\t\t},\n\t\t\tagent: {\n\t\t\t\t_id: agent._id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tname: agent.name,\n\t\t\t\temail: null\n\t\t\t}\n\t\t};\n\n\t\tif (room.crmData) {\n\t\t\tpostData.crmData = room.crmData;\n\t\t}\n\n\t\tif (visitor.emails && visitor.emails.length > 0) {\n\t\t\tpostData.visitor.email = visitor.emails[0].address;\n\t\t}\n\t\tif (visitor.phone && visitor.phone.length > 0) {\n\t\t\tpostData.visitor.phone = visitor.phone[0].phoneNumber;\n\t\t}\n\n\t\tif (agent.emails && agent.emails.length > 0) {\n\t\t\tpostData.agent.email = agent.emails[0].address;\n\t\t}\n\n\t\treturn postData;\n\t},\n\n\taddAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, true);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'available');\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\taddManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addManager' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-manager')) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.removeUserFromRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, false);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'not-available');\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.authz.removeUserFromRoles(user._id, 'livechat-manager');\n\t},\n\n\tsaveDepartment(_id, departmentData, departmentAgents) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(departmentData, {\n\t\t\tenabled: Boolean,\n\t\t\tname: String,\n\t\t\tdescription: Match.Optional(String)\n\t\t});\n\n\t\tcheck(departmentAgents, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tagentId: String,\n\t\t\t\tusername: String\n\t\t\t})\n\t\t]);\n\n\t\tif (_id) {\n\t\t\tconst department = RocketChat.models.LivechatDepartment.findOneById(_id);\n\t\t\tif (!department) {\n\t\t\t\tthrow new Meteor.Error('error-department-not-found', 'Department not found', { method: 'livechat:saveDepartment' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.createOrUpdateDepartment(_id, departmentData.enabled, departmentData.name, departmentData.description, departmentAgents);\n\t},\n\n\tremoveDepartment(_id) {\n\t\tcheck(_id, String);\n\n\t\tvar department = RocketChat.models.LivechatDepartment.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!department) {\n\t\t\tthrow new Meteor.Error('department-not-found', 'Department not found', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.removeById(_id);\n\t}\n};\n\nRocketChat.settings.get('Livechat_history_monitor_type', (key, value) => {\n\tRocketChat.Livechat.historyMonitorType = value;\n});\n","RocketChat.QueueMethods = {\n\t/* Least Amount Queuing method:\n\t *\n\t * default method where the agent with the least number\n\t * of open chats is paired with the incoming livechat\n\t */\n\t'Least_Amount' : function(guest, message, roomInfo) {\n\t\tconst agent = RocketChat.Livechat.getNextAgent(guest.department);\n\t\tif (!agent) {\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t}\n\n\t\tconst roomCode = RocketChat.models.Rooms.getNextLivechatRoomCode();\n\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 1,\n\t\t\tlm: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tlabel: guest.name || guest.username,\n\t\t\tusernames: [agent.username, guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\ttoken: message.token\n\t\t\t},\n\t\t\tservedBy: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true\n\t\t}, roomInfo);\n\t\tlet subscriptionData = {\n\t\t\trid: message.rid,\n\t\t\tname: guest.name || guest.username,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tcode: roomCode,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all'\n\t\t};\n\n\t\tRocketChat.models.Rooms.insert(room);\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\treturn room;\n\t},\n\t/* Guest Pool Queuing Method:\n\t *\n\t * An incomming livechat is created as an Inquiry\n\t * which is picked up from an agent.\n\t * An Inquiry is visible to all agents (TODO: in the correct department)\n     *\n\t * A room is still created with the initial message, but it is occupied by\n\t * only the client until paired with an agent\n\t */\n\t'Guest_Pool' : function(guest, message, roomInfo) {\n\t\tlet agents = RocketChat.Livechat.getOnlineAgents(guest.department);\n\n\t\tif (agents.count() === 0 && RocketChat.settings.get('Livechat_guest_pool_with_no_agents')) {\n\t\t\tagents = RocketChat.Livechat.getAgents(guest.department);\n\t\t}\n\n\t\tif (agents.count() === 0) {\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t}\n\n\t\tconst roomCode = RocketChat.models.Rooms.getNextLivechatRoomCode();\n\n\t\tconst agentIds = [];\n\n\t\tagents.forEach((agent) => {\n\t\t\tif (guest.department) {\n\t\t\t\tagentIds.push(agent.agentId);\n\t\t\t} else {\n\t\t\t\tagentIds.push(agent._id);\n\t\t\t}\n\t\t});\n\n\t\tvar inquiry = {\n\t\t\trid: message.rid,\n\t\t\tmessage: message.msg,\n\t\t\tname: guest.name || guest.username,\n\t\t\tts: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tdepartment: guest.department,\n\t\t\tagents: agentIds,\n\t\t\tstatus: 'open',\n\t\t\tt: 'l'\n\t\t};\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 1,\n\t\t\tlm: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tlabel: guest.name || guest.username,\n\t\t\tusernames: [guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\ttoken: message.token\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true\n\t\t}, roomInfo);\n\t\tRocketChat.models.LivechatInquiry.insert(inquiry);\n\t\tRocketChat.models.Rooms.insert(room);\n\n\t\treturn room;\n\t}\n};\n","// Every minute check if office closed\nMeteor.setInterval(function() {\n\tif (RocketChat.settings.get('Livechat_enable_office_hours')) {\n\t\tif (RocketChat.models.LivechatOfficeHour.isOpeningTime()) {\n\t\t\tRocketChat.models.Users.openOffice();\n\t\t} else if (RocketChat.models.LivechatOfficeHour.isClosingTime()) {\n\t\t\tRocketChat.models.Users.closeOffice();\n\t\t}\n\t}\n}, 60000);","RocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!RocketChat.SMS.enabled) {\n\t\treturn message;\n\t}\n\n\t// only send the sms by SMS if it is a livechat room with SMS set to true\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.sms && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tconst SMSService = RocketChat.SMS.getService(RocketChat.settings.get('SMS_Service'));\n\n\tif (!SMSService) {\n\t\treturn message;\n\t}\n\n\tconst visitor = RocketChat.models.Users.getVisitorByToken(room.v.token);\n\n\tif (!visitor || !visitor.profile || !visitor.phone || visitor.phone.length === 0) {\n\t\treturn message;\n\t}\n\n\tSMSService.send(room.sms.from, visitor.phone[0].phoneNumber, message.msg);\n\n\treturn message;\n\n}, RocketChat.callbacks.priority.LOW, 'sendMessageBySms');\n","/* globals UserPresenceMonitor */\n\nlet agentsHandler;\nlet monitorAgents = false;\nlet actionTimeout = 60000;\n\nlet onlineAgents = {\n\tusers: {},\n\tqueue: {},\n\n\tadd(userId) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t\tdelete this.queue[userId];\n\t\t}\n\t\tthis.users[userId] = 1;\n\t},\n\n\tremove(userId, callback) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t}\n\t\tthis.queue[userId] = setTimeout(Meteor.bindEnvironment(() => {\n\t\t\tcallback();\n\n\t\t\tdelete this.users[userId];\n\t\t\tdelete this.queue[userId];\n\t\t}), actionTimeout);\n\t},\n\n\texists(userId) {\n\t\treturn !!this.users[userId];\n\t}\n};\n\nfunction runAgentLeaveAction(userId) {\n\tconst action = RocketChat.settings.get('Livechat_agent_leave_action');\n\tif (action === 'close') {\n\t\treturn RocketChat.Livechat.closeOpenChats(userId, RocketChat.settings.get('Livechat_agent_leave_comment'));\n\t} else if (action === 'forward') {\n\t\treturn RocketChat.Livechat.forwardOpenChats(userId);\n\t}\n}\n\nRocketChat.settings.get('Livechat_agent_leave_action_timeout', function(key, value) {\n\tactionTimeout = value * 1000;\n});\n\nRocketChat.settings.get('Livechat_agent_leave_action', function(key, value) {\n\tmonitorAgents = value;\n\tif (value !== 'none') {\n\t\tif (!agentsHandler) {\n\t\t\tagentsHandler = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t\t\t\tadded(id) {\n\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t},\n\t\t\t\tchanged(id, fields) {\n\t\t\t\t\tif (fields.statusLivechat && fields.statusLivechat === 'not-available') {\n\t\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tremoved(id) {\n\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t} else if (agentsHandler) {\n\t\tagentsHandler.stop();\n\t\tagentsHandler = null;\n\t}\n});\n\nUserPresenceMonitor.onSetUserStatus((user, status, statusConnection) => {\n\tif (!monitorAgents) {\n\t\treturn;\n\t}\n\tif (onlineAgents.exists(user._id)) {\n\t\tif (statusConnection === 'offline' || user.statusLivechat === 'not-available') {\n\t\t\tonlineAgents.remove(user._id, () => {\n\t\t\t\trunAgentLeaveAction(user._id);\n\t\t\t});\n\t\t}\n\t}\n});\n","Meteor.publish('livechat:customFields', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (s.trim(_id)) {\n\t\treturn RocketChat.models.LivechatCustomField.find({ _id: _id });\n\t}\n\n\treturn RocketChat.models.LivechatCustomField.find();\n\n});\n","Meteor.publish('livechat:departmentAgents', function(departmentId) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\treturn RocketChat.models.LivechatDepartmentAgents.find({ departmentId: departmentId });\n});\n","Meteor.publish('livechat:externalMessages', function(roomId) {\n\treturn RocketChat.models.LivechatExternalMessage.findByRoomId(roomId);\n});\n","Meteor.publish('livechat:agents', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tvar self = this;\n\n\tvar handle = RocketChat.authz.getUsersInRole('livechat-agent').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('agentUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('agentUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('agentUsers', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:departments', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatDepartment.findByDepartmentId(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatDepartment.find();\n\t}\n\n});\n","Meteor.publish('livechat:integration', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tvar self = this;\n\n\tvar handle = RocketChat.models.Settings.findByIds(['Livechat_webhookUrl', 'Livechat_secret_token', 'Livechat_webhook_on_close', 'Livechat_webhook_on_offline_msg']).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatIntegration', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatIntegration', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatIntegration', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:managers', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tvar self = this;\n\n\tvar handle = RocketChat.authz.getUsersInRole('livechat-manager').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('managerUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('managerUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('managerUsers', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:rooms', function(filter = {}, offset = 0, limit = 20) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tcheck(filter, {\n\t\tname: Match.Maybe(String), // room name to filter\n\t\tagent: Match.Maybe(String), // agent _id who is serving\n\t\tstatus: Match.Maybe(String), // either 'opened' or 'closed'\n\t\tfrom: Match.Maybe(String),\n\t\tto: Match.Maybe(String)\n\t});\n\n\tlet query = {};\n\tif (filter.name) {\n\t\tquery.label = new RegExp(filter.name, 'i');\n\t}\n\tif (filter.agent) {\n\t\tquery['servedBy._id'] = filter.agent;\n\t}\n\tif (filter.status) {\n\t\tif (filter.status === 'opened') {\n\t\t\tquery.open = true;\n\t\t} else {\n\t\t\tquery.open = { $exists: false };\n\t\t}\n\t}\n\tif (filter.from && filter.to) {\n\t\tvar StartDate = new Date(filter.from);\n\t\tvar ToDate = new Date(filter.to);\n\t\tToDate.setDate(ToDate.getDate() + 1);\n\t\tquery['ts'] = { $gt: StartDate, $lt: ToDate };\n\t}\n\n\treturn RocketChat.models.Rooms.findLivechat(query, offset, limit);\n});\n","Meteor.publish('livechat:queue', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\t// let sort = { count: 1, sort: 1, username: 1 };\n\t// let onlineUsers = {};\n\n\t// let handleUsers = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t// \tadded(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.added('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tchanged(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.changed('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tremoved(id) {\n\t// \t\tthis.removed('livechatQueueUser', id);\n\t// \t}\n\t// });\n\n\tlet self = this;\n\n\tlet handleDepts = RocketChat.models.LivechatDepartmentAgents.findUsersInQueue().observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatQueueUser', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatQueueUser', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatQueueUser', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\t// handleUsers.stop();\n\t\thandleDepts.stop();\n\t});\n});\n","Meteor.publish('livechat:visitorHistory', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tvar room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tconst user = RocketChat.models.Users.findOneById(this.userId);\n\n\tif (room.usernames.indexOf(user.username) === -1) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tif (room && room.v && room.v._id) {\n\t\treturn RocketChat.models.Rooms.findByVisitorId(room.v._id);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:visitorInfo', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tvar room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room && room.v && room.v._id) {\n\t\treturn RocketChat.models.Users.findById(room.v._id);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:visitorPageVisited', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tvar room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room && room.v && room.v.token) {\n\t\treturn RocketChat.models.LivechatPageVisited.findByToken(room.v.token);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:inquiry', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\n\treturn RocketChat.models.LivechatInquiry.find();\n});\n","Meteor.publish('livechat:officeHour', function() {\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\treturn RocketChat.models.LivechatOfficeHour.find();\n});","import '../imports/server/rest/departments.js';\nimport '../imports/server/rest/sms.js';\nimport '../imports/server/rest/users.js';\n","Meteor.startup(() => {\n\tvar roles = _.pluck(RocketChat.models.Roles.find().fetch(), 'name');\n\tif (roles.indexOf('livechat-agent') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-agent');\n\t}\n\tif (roles.indexOf('livechat-manager') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-manager');\n\t}\n\tif (roles.indexOf('livechat-guest') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-guest');\n\t}\n\tif (RocketChat.models && RocketChat.models.Permissions) {\n\t\tRocketChat.models.Permissions.createOrUpdate('view-l-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-manager', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-rooms', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-livechat-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-others-livechat-room', ['livechat-manager', 'admin']);\n\t}\n});\n","RocketChat.MessageTypes.registerType({\n\tid: 'livechat_video_call',\n\tsystem: true,\n\tmessage: 'New_videocall_request'\n});\n\nRocketChat.actionLinks.register('createLivechatCall', function(/*message, params*/) {\n\tif (Meteor.isClient) {\n\t\tRocketChat.TabBar.setTemplate('videoFlexTab');\n\n\t\t// calling openFlex should set the width instead of having to do this.\n\t\t$('.flex-tab').css('max-width', '790px');\n\n\t\tRocketChat.TabBar.openFlex();\n\t}\n});\n\nRocketChat.actionLinks.register('denyLivechatCall', function(message/*, params*/) {\n\tif (Meteor.isServer) {\n\t\tconst user = Meteor.user();\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('command', message.rid, 'endCall', user);\n\t\tRocketChat.Notifications.notifyRoom(message.rid, 'deleteMessage', { _id: message._id });\n\n\t\tconst language = user.language || RocketChat.settings.get('language') || 'en';\n\n\t\tRocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom: RocketChat.models.Rooms.findOneById(message.rid),\n\t\t\tcomment: TAPi18n.__('Videocall_declined', { lng: language })\n\t\t});\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.models.Messages.setHiddenById(message._id);\n\t\t});\n\t}\n});\n","/* globals openRoom */\n\nRocketChat.roomTypes.add('l', 5, {\n\ttemplate: 'livechat',\n\ticon: 'icon-chat-empty',\n\troute: {\n\t\tname: 'live',\n\t\tpath: '/live/:code(\\\\d+)',\n\t\taction(params/*, queryParams*/) {\n\t\t\topenRoom('l', params.code);\n\t\t\tRocketChat.TabBar.showGroup('livechat', 'search');\n\t\t},\n\t\tlink(sub) {\n\t\t\treturn {\n\t\t\t\tcode: sub.code\n\t\t\t};\n\t\t}\n\t},\n\n\tfindRoom(identifier) {\n\t\treturn ChatRoom.findOne({ code: parseInt(identifier) });\n\t},\n\n\troomName(roomData) {\n\t\tif (!roomData.name) {\n\t\t\treturn roomData.label;\n\t\t} else {\n\t\t\treturn roomData.name;\n\t\t}\n\t},\n\n\tcondition() {\n\t\treturn RocketChat.settings.get('Livechat_enabled') && RocketChat.authz.hasAllPermission('view-l-room');\n\t},\n\n\tcanSendMessage(roomId) {\n\t\tlet room = ChatRoom.findOne({ _id: roomId }, { fields: { open: 1 } });\n\t\treturn room && room.open === true;\n\t},\n\n\tnotSubscribedTpl: {\n\t\ttemplate: 'livechatNotSubscribed'\n\t}\n});\n","Meteor.startup(function() {\n\tRocketChat.settings.addGroup('Livechat');\n\n\tRocketChat.settings.add('Livechat_enabled', false, { type: 'boolean', group: 'Livechat', public: true });\n\n\tRocketChat.settings.add('Livechat_title', 'Rocket.Chat', { type: 'string', group: 'Livechat', public: true });\n\tRocketChat.settings.add('Livechat_title_color', '#C1272D', { type: 'color', group: 'Livechat', public: true });\n\n\tRocketChat.settings.add('Livechat_display_offline_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Display_offline_form'\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_form_unavailable', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_form_unavailable_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_title', 'Leave a message', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Title'\n\t});\n\tRocketChat.settings.add('Livechat_offline_title_color', '#666666', {\n\t\ttype: 'color',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Color'\n\t});\n\tRocketChat.settings.add('Livechat_offline_message', 'We are not online right now. Please leave us a message:', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Instructions',\n\t\ti18nDescription: 'Instructions_to_your_visitor_fill_the_form_to_send_a_message'\n\t});\n\tRocketChat.settings.add('Livechat_offline_email', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Email_address_to_send_offline_messages',\n\t\tsection: 'Offline'\n\t});\n\tRocketChat.settings.add('Livechat_offline_success_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_success_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_registration_form', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Show_preregistration_form' });\n\tRocketChat.settings.add('Livechat_guest_count', 1, { type: 'int', group: 'Livechat' });\n\n\tRocketChat.settings.add('Livechat_Room_Count', 1, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Livechat_room_count'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action', 'none', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tvalues: [\n\t\t\t{ key: 'none', i18nLabel: 'None' },\n\t\t\t{ key: 'forward', i18nLabel: 'Forward' },\n\t\t\t{ key: 'close', i18nLabel: 'Close' }\n\t\t],\n\t\ti18nLabel: 'How_to_handle_open_sessions_when_agent_goes_offline'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action_timeout', 60, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: { $ne: 'none' } },\n\t\ti18nLabel: 'How_long_to_wait_after_agent_goes_offline',\n\t\ti18nDescription: 'Time_in_seconds'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_comment', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: 'close' },\n\t\ti18nLabel: 'Comment_to_leave_on_closing_session'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhookUrl', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM Integration',\n\t\ti18nLabel: 'Webhook_URL'\n\t});\n\n\tRocketChat.settings.add('Livechat_secret_token', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM Integration',\n\t\ti18nLabel: 'Secret_token'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_close', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM Integration',\n\t\ti18nLabel: 'Send_request_on_chat_close'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_offline_msg', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM Integration',\n\t\ti18nLabel: 'Send_request_on_offline_messages'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Key', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Key'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Language', 'en', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Language'\n\t});\n\n\tRocketChat.settings.add('Livechat_history_monitor_type', 'url', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Monitor_history_for_changes_on',\n\t\tvalues: [\n\t\t\t{ key: 'url', i18nLabel: 'Page_URL' },\n\t\t\t{ key: 'title', i18nLabel: 'Page_title' }\n\t\t]\n\t});\n\n\tRocketChat.settings.add('Livechat_Routing_Method', 'Least_Amount', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tvalues: [\n\t\t\t{key: 'Least_Amount', i18nLabel: 'Least_Amount'},\n\t\t\t{key: 'Guest_Pool', i18nLabel: 'Guest_Pool'}\n\t\t]\n\t});\n\n\tRocketChat.settings.add('Livechat_guest_pool_with_no_agents', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Accept_with_no_online_agents',\n\t\ti18nDescription: 'Accept_incoming_livechat_requests_even_if_there_are_no_online_agents',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' }\n\t});\n\n\tRocketChat.settings.add('Livechat_show_queue_list_link', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Show_queue_list_to_all_agents'\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_office_hours', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Office_Hours_Enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_videocall_enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Videocall_enabled',\n\t\ti18nDescription: 'Beta_feature_Depends_on_Video_Conference_to_be_enabled',\n\t\tenableQuery: { _id: 'Jitsi_Enabled', value: true }\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_transcript', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_Enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_transcript_message', 'Would you like a copy of this chat emailed?', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_message',\n\t\tenableQuery: { _id: 'Livechat_enable_transcript', value: true }\n\t});\n\n});\n","RocketChat.theme.addPackageAsset(() => {\n\treturn Assets.getText('client/stylesheets/livechat.less');\n});\n","RocketChat.API.v1.addRoute('livechat/department', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\treturn RocketChat.API.v1.success({\n\t\t\tdepartments: RocketChat.models.LivechatDepartment.find().fetch()\n\t\t});\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array\n\t\t\t});\n\n\t\t\tconst department = RocketChat.Livechat.saveDepartment(null, this.bodyParams.department, this.bodyParams.agents);\n\n\t\t\tif (department) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment: department,\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: department._id }).fetch()\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tRocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/department/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch()\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tput() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.saveDepartment(this.urlParams._id, this.bodyParams.department, this.bodyParams.agents)) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch()\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.removeDepartment(this.urlParams._id)) {\n\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n","RocketChat.API.v1.addRoute('livechat/sms-incoming/:service', {\n\tpost() {\n\t\tconst SMSService = RocketChat.SMS.getService(this.urlParams.service);\n\n\t\tconst sms = SMSService.parse(this.bodyParams);\n\n\t\tvar visitor = RocketChat.models.Users.findOneVisitorByPhone(sms.from);\n\n\t\tlet sendMessage = {\n\t\t\tmessage: {\n\t\t\t\t_id: Random.id()\n\t\t\t},\n\t\t\troomInfo: {\n\t\t\t\tsms: {\n\t\t\t\t\tfrom: sms.to\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitor.profile.token).fetch();\n\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\tsendMessage.message.rid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\tsendMessage.message.rid = Random.id();\n\t\t\t}\n\t\t\tsendMessage.message.token = visitor.profile.token;\n\t\t} else {\n\t\t\tsendMessage.message.rid = Random.id();\n\t\t\tsendMessage.message.token = Random.id();\n\n\t\t\tlet userId = RocketChat.Livechat.registerGuest({\n\t\t\t\tusername: sms.from.replace(/[^0-9]/g, ''),\n\t\t\t\ttoken: sendMessage.message.token,\n\t\t\t\tphone: {\n\t\t\t\t\tnumber: sms.from\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvisitor = RocketChat.models.Users.findOneById(userId);\n\t\t}\n\n\t\tsendMessage.message.msg = sms.body;\n\t\tsendMessage.guest = visitor;\n\n\t\ttry {\n\t\t\tconst message = SMSService.response.call(this, RocketChat.Livechat.sendMessage(sendMessage));\n\n\t\t\tMeteor.defer(() => {\n\t\t\t\tif (sms.extra) {\n\t\t\t\t\tif (sms.extra.fromCountry) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'country', sms.extra.fromCountry);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromState) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'state', sms.extra.fromState);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromCity) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'city', sms.extra.fromCity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn message;\n\t\t} catch (e) {\n\t\t\treturn SMSService.error.call(this, e);\n\t\t}\n\t}\n});\n","RocketChat.API.v1.addRoute('livechat/users/:type', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String\n\t\t\t});\n\n\t\t\tlet role;\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tlet users = RocketChat.authz.getUsersInRole(role);\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tusers: users.fetch().map(user => ({ _id: user._id, username: user.username }))\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tusername: String\n\t\t\t});\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tconst user = RocketChat.Livechat.addAgent(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tconst user = RocketChat.Livechat.addManager(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/users/:type/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure('User not found');\n\t\t\t}\n\n\t\t\tlet role;\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tif (user.roles.indexOf(role) !== -1) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tuser: _.pick(user, '_id', 'username')\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tuser: null\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure();\n\t\t\t}\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tif (RocketChat.Livechat.removeAgent(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tif (RocketChat.Livechat.removeManager(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n"]}