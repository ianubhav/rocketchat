{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:file-upload/globalFileRestrictions.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUploadBase.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/requests.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/configFileUploadAmazonS3.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/configFileUploadFileSystem.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/configFileUploadGridFS.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/sendFileMessage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/startup/settings.js"],"names":["filesize","Slingshot","fileRestrictions","authorize","file","RocketChat","fileUploadIsValidContentType","type","Meteor","Error","TAPi18n","__","maxFileSize","settings","get","size","userId","maxSize","allowedFileTypes","FileUpload","validateFileUpload","user","reason","language","key","value","FileUploadBase","meta","id","Random","getProgress","getFileName","name","start","stop","mime","Npm","require","handlers","addHandler","store","handler","fileId","models","Uploads","findOneById","remove","_id","req","res","next","call","writeHead","end","addExtensionTo","lookup","ext","extension","RegExp","test","protectedFiles","WebApp","connectHandlers","use","match","exec","url","sandstorm","cookie","rawCookies","ref","token","uid","Cookies","headers","query","rc_uid","rc_token","Users","findOneByIdAndLoginToken","crypto","S3accessKey","S3secretKey","S3expiryTimeSpan","generateURL","s3","resourceURL","bucket","path","expires","parseInt","Date","getTime","Math","max","StringToSign","signature","createHmac","update","Buffer","digest","encodeURIComponent","fileUrl","setHeader","AWS","S3","request","deleteObject","Bucket","Key","send","createS3Directive","_","debounce","directiveName","acl","accessKey","secretKey","cdn","region","bucketUrl","config","accessKeyId","secretAccessKey","isEmpty","_directives","AWSAccessKeyId","AWSSecretAccessKey","metaContext","hostname","rid","upload","insertFileInit","createDirective","S3Storage","e","SystemLogger","error","message","storeName","FileSystemStore","createFileSystemStore","stores","UploadFS","getStores","Local","collection","model","filter","Filter","onCheck","transformWrite","readStream","writeStream","RocketChatFile","enabled","pipe","stream","identify","err","data","format","undefined","indexOf","Orientation","gm","autoOrient","fs","filePath","getFilePath","stat","wrapAsync","isFile","uploadedAt","toUTCString","getReadStream","zlib","readFromGridFS","getStore","rs","ws","PassThrough","on","onReadError","emit","accept","transformRead","createGzip","createDeflate","fileStore","methods","roomId","method","room","updateFileComplete","omit","attachment","title","title_link","title_link_download","image_url","image_type","image_size","image_dimensions","audio_url","audio_type","audio_size","video_url","video_type","video_size","msg","groupable","attachments","addGroup","add","i18nDescription","values","i18nLabel","section","enableQuery"],"mappings":"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","file":"/packages/rocketchat_file-upload.js","sourcesContent":["/* globals Slingshot */\n\nimport filesize from 'filesize';\n\nSlingshot.fileRestrictions('rocketchat-uploads', {\n\tauthorize: function(file/*, metaContext*/) {\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('error-invalid-file-type'));\n\t\t}\n\n\t\tvar maxFileSize = RocketChat.settings.get('FileUpload_MaxFileSize');\n\n\t\tif (maxFileSize && maxFileSize < file.size) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('File_exceeds_allowed_size_of_bytes', { size: filesize(maxFileSize) }));\n\t\t}\n\n\t\t//Deny uploads if user is not logged in.\n\t\tif (!this.userId) {\n\t\t\tthrow new Meteor.Error('login-require', 'Please login before posting files');\n\t\t}\n\n\t\treturn true;\n\t},\n\tmaxSize: 0,\n\tallowedFileTypes: null\n});\n","/* globals FileUpload:true */\n/* exported FileUpload */\n\nimport filesize from 'filesize';\n\nlet maxFileSize = 0;\n\nFileUpload = {\n\tvalidateFileUpload(file) {\n\t\tif (file.size > maxFileSize) {\n\t\t\tconst user = Meteor.user();\n\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t}, user.language);\n\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tconst user = Meteor.user();\n\t\t\tconst reason = TAPi18n.__('File_type_is_not_accepted', user.language);\n\t\t\tthrow new Meteor.Error('error-invalid-file-type', reason);\n\t\t}\n\n\t\treturn true;\n\t}\n};\n\nRocketChat.settings.get('FileUpload_MaxFileSize', function(key, value) {\n\tmaxFileSize = value;\n});\n","/* globals FileUploadBase:true */\n/* exported FileUploadBase */\n\nFileUploadBase = class FileUploadBase {\n\tconstructor(meta, file) {\n\t\tthis.id = Random.id();\n\t\tthis.meta = meta;\n\t\tthis.file = file;\n\t}\n\n\tgetProgress() {\n\n\t}\n\n\tgetFileName() {\n\t\treturn this.meta.name;\n\t}\n\n\tstart() {\n\n\t}\n\n\tstop() {\n\n\t}\n};\n","/* globals FileUpload:true */\nconst mime = Npm.require('mime-types');\n\nFileUpload.handlers = {};\n\nFileUpload.addHandler = function(store, handler) {\n\tthis.handlers[store] = handler;\n};\n\nFileUpload.delete = function(fileId) {\n\tlet file = RocketChat.models.Uploads.findOneById(fileId);\n\n\tif (!file) {\n\t\treturn;\n\t}\n\n\tthis.handlers[file.store].delete(file);\n\n\treturn RocketChat.models.Uploads.remove(file._id);\n};\n\nFileUpload.get = function(file, req, res, next) {\n\tif (file.store && this.handlers && this.handlers[file.store] && this.handlers[file.store].get) {\n\t\tthis.handlers[file.store].get.call(this, file, req, res, next);\n\t} else {\n\t\tres.writeHead(404);\n\t\tres.end();\n\t\treturn;\n\t}\n};\n\nFileUpload.addExtensionTo = function(file) {\n\tif (mime.lookup(file.name) === file.type) {\n\t\treturn file;\n\t}\n\n\tconst ext = mime.extension(file.type);\n\tif (ext && false === new RegExp(`\\.${ext}$`, 'i').test(file.name)) {\n\t\tfile.name = `${file.name}.${ext}`;\n\t}\n\n\treturn file;\n};\n","/* globals FileUpload, WebApp, Cookies */\nvar protectedFiles;\n\nRocketChat.settings.get('FileUpload_ProtectFiles', function(key, value) {\n\tprotectedFiles = value;\n});\n\nWebApp.connectHandlers.use('/file-upload/', function(req, res, next) {\n\tvar file;\n\n\tvar match = /^\\/([^\\/]+)\\/(.*)/.exec(req.url);\n\n\tif (match[1]) {\n\t\tfile = RocketChat.models.Uploads.findOneById(match[1]);\n\n\t\tif (file) {\n\t\t\tif (!Meteor.settings.public.sandstorm && protectedFiles) {\n\t\t\t\tvar cookie, rawCookies, ref, token, uid;\n\t\t\t\tcookie = new Cookies();\n\n\t\t\t\tif ((typeof req !== 'undefined' && req !== null ? (ref = req.headers) != null ? ref.cookie : void 0 : void 0) != null) {\n\t\t\t\t\trawCookies = req.headers.cookie;\n\t\t\t\t}\n\n\t\t\t\tif (rawCookies != null) {\n\t\t\t\t\tuid = cookie.get('rc_uid', rawCookies);\n\t\t\t\t}\n\n\t\t\t\tif (rawCookies != null) {\n\t\t\t\t\ttoken = cookie.get('rc_token', rawCookies);\n\t\t\t\t}\n\n\t\t\t\tif (uid == null) {\n\t\t\t\t\tuid = req.query.rc_uid;\n\t\t\t\t\ttoken = req.query.rc_token;\n\t\t\t\t}\n\n\t\t\t\tif (!(uid && token && RocketChat.models.Users.findOneByIdAndLoginToken(uid, token))) {\n\t\t\t\t\tres.writeHead(403);\n\t\t\t\t\tres.end();\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn FileUpload.get(file, req, res, next);\n\t\t}\n\t}\n\n\tres.writeHead(404);\n\tres.end();\n\treturn;\n});\n","/* globals Slingshot, FileUpload, AWS, SystemLogger */\nvar crypto = Npm.require('crypto');\n\nvar S3accessKey, S3secretKey, S3expiryTimeSpan;\n\nvar generateURL = function(file) {\n\tif (!file || !file.s3) {\n\t\treturn;\n\t}\n\tlet resourceURL = '/' + file.s3.bucket + '/' + file.s3.path + file._id;\n\tlet expires = parseInt(new Date().getTime() / 1000) + Math.max(5, S3expiryTimeSpan);\n\tlet StringToSign = 'GET\\n\\n\\n' + expires +'\\n'+resourceURL;\n\tlet signature = crypto.createHmac('sha1', S3secretKey).update(new Buffer(StringToSign, 'utf-8')).digest('base64');\n\treturn file.url + '?AWSAccessKeyId='+encodeURIComponent(S3accessKey)+'&Expires='+expires+'&Signature='+encodeURIComponent(signature);\n};\n\nFileUpload.addHandler('s3', {\n\tget(file, req, res) {\n\t\tlet fileUrl = generateURL(file);\n\n\t\tif (fileUrl) {\n\t\t\tres.setHeader('Location', fileUrl);\n\t\t\tres.writeHead(302);\n\t\t}\n\t\tres.end();\n\t},\n\tdelete(file) {\n\t\tlet s3 = new AWS.S3();\n\t\tlet request = s3.deleteObject({\n\t\t\tBucket: file.s3.bucket,\n\t\t\tKey: file.s3.path + file._id\n\t\t});\n\t\trequest.send();\n\t}\n});\n\nvar createS3Directive = _.debounce(() => {\n\tvar directiveName = 'rocketchat-uploads';\n\n\tvar type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tvar bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tvar acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tvar accessKey = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tvar secretKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tvar cdn = RocketChat.settings.get('FileUpload_S3_CDN');\n\tvar region = RocketChat.settings.get('FileUpload_S3_Region');\n\tvar bucketUrl = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tAWS.config.update({\n\t\taccessKeyId: RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId'),\n\t\tsecretAccessKey: RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey')\n\t});\n\n\tif (type === 'AmazonS3' && !_.isEmpty(bucket) && !_.isEmpty(accessKey) && !_.isEmpty(secretKey)) {\n\t\tif (Slingshot._directives[directiveName]) {\n\t\t\tdelete Slingshot._directives[directiveName];\n\t\t}\n\t\tvar config = {\n\t\t\tbucket: bucket,\n\t\t\tAWSAccessKeyId: accessKey,\n\t\t\tAWSSecretAccessKey: secretKey,\n\t\t\tkey: function(file, metaContext) {\n\t\t\t\tvar path = RocketChat.hostname + '/' + metaContext.rid + '/' + this.userId + '/';\n\n\t\t\t\tlet upload = {\n\t\t\t\t\ts3: {\n\t\t\t\t\t\tbucket: bucket,\n\t\t\t\t\t\tregion: region,\n\t\t\t\t\t\tpath: path\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tlet fileId = RocketChat.models.Uploads.insertFileInit(metaContext.rid, this.userId, 's3', file, upload);\n\n\t\t\t\treturn path + fileId;\n\t\t\t}\n\t\t};\n\n\t\tif (!_.isEmpty(acl)) {\n\t\t\tconfig.acl = acl;\n\t\t}\n\n\t\tif (!_.isEmpty(cdn)) {\n\t\t\tconfig.cdn = cdn;\n\t\t}\n\n\t\tif (!_.isEmpty(region)) {\n\t\t\tconfig.region = region;\n\t\t}\n\n\t\tif (!_.isEmpty(bucketUrl)) {\n\t\t\tconfig.bucketUrl = bucketUrl;\n\t\t}\n\n\t\ttry {\n\t\t\tSlingshot.createDirective(directiveName, Slingshot.S3Storage, config);\n\t\t} catch (e) {\n\t\t\tSystemLogger.error('Error configuring S3 ->', e.message);\n\t\t}\n\t} else if (Slingshot._directives[directiveName]) {\n\t\tdelete Slingshot._directives[directiveName];\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_Bucket', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_Acl', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_AWSAccessKeyId', function(key, value) {\n\tS3accessKey = value;\n\tcreateS3Directive();\n});\n\nRocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey', function(key, value) {\n\tS3secretKey = value;\n\tcreateS3Directive();\n});\n\nRocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan', function(key, value) {\n\tS3expiryTimeSpan = value;\n\tcreateS3Directive();\n});\n\nRocketChat.settings.get('FileUpload_S3_CDN', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_Region', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_BucketURL', createS3Directive);\n","/* globals FileSystemStore:true, FileUpload, UploadFS, RocketChatFile */\n\nlet storeName = 'fileSystem';\n\nFileSystemStore = null;\n\nlet createFileSystemStore = _.debounce(function() {\n\tlet stores = UploadFS.getStores();\n\tif (stores[storeName]) {\n\t\tdelete stores[storeName];\n\t}\n\tFileSystemStore = new UploadFS.store.Local({\n\t\tcollection: RocketChat.models.Uploads.model,\n\t\tname: storeName,\n\t\tpath: RocketChat.settings.get('FileUpload_FileSystemPath'), //'/tmp/uploads/photos',\n\t\tfilter: new UploadFS.Filter({\n\t\t\tonCheck: FileUpload.validateFileUpload\n\t\t}),\n\t\ttransformWrite: function(readStream, writeStream, fileId, file) {\n\t\t\tif (RocketChatFile.enabled === false || !/^image\\/((x-windows-)?bmp|p?jpeg|png)$/.test(file.type)) {\n\t\t\t\treturn readStream.pipe(writeStream);\n\t\t\t}\n\n\t\t\tlet stream = void 0;\n\n\t\t\tconst identify = function(err, data) {\n\t\t\t\tif (err != null) {\n\t\t\t\t\treturn stream.pipe(writeStream);\n\t\t\t\t}\n\n\t\t\t\tfile.identify = {\n\t\t\t\t\tformat: data.format,\n\t\t\t\t\tsize: data.size\n\t\t\t\t};\n\n\t\t\t\tif ([null, undefined, '', 'Unknown', 'Undefined'].indexOf(data.Orientation) === -1) {\n\t\t\t\t\treturn RocketChatFile.gm(stream).autoOrient().stream().pipe(writeStream);\n\t\t\t\t} else {\n\t\t\t\t\treturn stream.pipe(writeStream);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tstream = RocketChatFile.gm(readStream).identify(identify).stream();\n\t\t\treturn;\n\t\t}\n\t});\n}, 500);\n\nRocketChat.settings.get('FileUpload_FileSystemPath', createFileSystemStore);\n\nvar fs = Npm.require('fs');\n\nFileUpload.addHandler(storeName, {\n\tget(file, req, res) {\n\t\tlet filePath = FileSystemStore.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tlet stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${encodeURIComponent(file.name)}`);\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tFileSystemStore.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t},\n\tdelete(file) {\n\t\treturn FileSystemStore.delete(file._id);\n\t}\n});\n","/* globals FileUpload, UploadFS */\nvar stream = Npm.require('stream');\nvar zlib = Npm.require('zlib');\n\n// code from: https://github.com/jalik/jalik-ufs/blob/master/ufs-server.js#L91\nvar readFromGridFS = function(storeName, fileId, file, headers, req, res) {\n\tvar store = UploadFS.getStore(storeName);\n\tvar rs = store.getReadStream(fileId, file);\n\tvar ws = new stream.PassThrough();\n\n\trs.on('error', function(err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tres.end();\n\t});\n\tws.on('error', function(err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tres.end();\n\t});\n\tws.on('close', function() {\n\t\t// Close output stream at the end\n\t\tws.emit('end');\n\t});\n\n\tvar accept = req.headers['accept-encoding'] || '';\n\n\t// Transform stream\n\tstore.transformRead(rs, ws, fileId, file, req, headers);\n\n\t// Compress data using gzip\n\tif (accept.match(/\\bgzip\\b/)) {\n\t\theaders['Content-Encoding'] = 'gzip';\n\t\tdelete headers['Content-Length'];\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(zlib.createGzip()).pipe(res);\n\t} else if (accept.match(/\\bdeflate\\b/)) {\n\t\t// Compress data using deflate\n\t\theaders['Content-Encoding'] = 'deflate';\n\t\tdelete headers['Content-Length'];\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(zlib.createDeflate()).pipe(res);\n\t} else {\n\t\t// Send raw data\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(res);\n\t}\n};\n\nFileUpload.addHandler('rocketchat_uploads', {\n\tget(file, req, res) {\n\t\tfile = FileUpload.addExtensionTo(file);\n\t\tlet headers = {\n\t\t\t'Content-Disposition': `attachment; filename*=UTF-8''${encodeURIComponent(file.name)}`,\n\t\t\t'Last-Modified': file.uploadedAt.toUTCString(),\n\t\t\t'Content-Type': file.type,\n\t\t\t'Content-Length': file.size\n\t\t};\n\t\treturn readFromGridFS(file.store, file._id, file, headers, req, res);\n\t},\n\tdelete(file) {\n\t\treturn Meteor.fileStore.delete(file._id);\n\t}\n});\n","Meteor.methods({\n\t'sendFileMessage'(roomId, store, file) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\n\t\tvar room = Meteor.call('canAccessRoom', roomId, Meteor.userId());\n\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tRocketChat.models.Uploads.updateFileComplete(file._id, Meteor.userId(), _.omit(file, '_id'));\n\n\t\tvar fileUrl = '/file-upload/' + file._id + '/' + file.name;\n\n\t\tvar attachment = {\n\t\t\ttitle: `${TAPi18n.__('Attachment_File_Uploaded')}: ${file.name}`,\n\t\t\ttitle_link: fileUrl,\n\t\t\ttitle_link_download: true\n\t\t};\n\n\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\tattachment.image_url = fileUrl;\n\t\t\tattachment.image_type = file.type;\n\t\t\tattachment.image_size = file.size;\n\t\t\tif (file.identify && file.identify.size) {\n\t\t\t\tattachment.image_dimensions = file.identify.size;\n\t\t\t}\n\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\tattachment.audio_url = fileUrl;\n\t\t\tattachment.audio_type = file.type;\n\t\t\tattachment.audio_size = file.size;\n\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\tattachment.video_url = fileUrl;\n\t\t\tattachment.video_type = file.type;\n\t\t\tattachment.video_size = file.size;\n\t\t}\n\n\t\tconst msg = {\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId,\n\t\t\tmsg: '',\n\t\t\tfile: {\n\t\t\t\t_id: file._id\n\t\t\t},\n\t\t\tgroupable: false,\n\t\t\tattachments: [attachment]\n\t\t};\n\n\t\treturn Meteor.call('sendMessage', msg);\n\t}\n});\n","RocketChat.settings.addGroup('FileUpload', function() {\n\tthis.add('FileUpload_Enabled', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MaxFileSize', 2097152, {\n\t\ttype: 'int',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MediaTypeWhiteList', 'image/*,audio/*,video/*,application/zip,application/x-rar-compressed,application/pdf,text/plain,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document', {\n\t\ttype: 'string',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_MediaTypeWhiteListDescription'\n\t});\n\n\tthis.add('FileUpload_ProtectFiles', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_ProtectFilesDescription'\n\t});\n\n\tthis.add('FileUpload_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'AmazonS3',\n\t\t\ti18nLabel: 'AmazonS3'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\tpublic: true\n\t});\n\n\tthis.section('Amazon S3', function() {\n\t\tthis.add('FileUpload_S3_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Acl', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSAccessKeyId', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSSecretAccessKey', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_CDN', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Region', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_BucketURL', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'Override_URL_to_which_files_are_uploaded_This_url_also_used_for_downloads_unless_a_CDN_is_given.'\n\t\t});\n\t\tthis.add('FileUpload_S3_URLExpiryTimeSpan', 120, {\n\t\t\ttype: 'int',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'FileUpload_S3_URLExpiryTimeSpan_Description'\n\t\t});\n\t});\n\n\tthis.section('File System', function() {\n\t\tthis.add('FileUpload_FileSystemPath', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'FileSystem'\n\t\t\t}\n\t\t});\n\t});\n});\n"]}