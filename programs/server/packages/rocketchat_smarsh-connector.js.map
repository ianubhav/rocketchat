{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/lib/rocketchat.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/models/SmarshHistory.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/functions/sendEmail.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/functions/generateEml.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/startup.js"],"names":["RocketChat","smarsh","settings","addGroup","addSettings","add","type","i18nLabel","enableQuery","_id","value","$exists","$ne","placeholder","zoneValues","moment","tz","names","map","_timeZonesToSettings","name","key","values","History","models","_Base","sendEmail","data","attachments","files","length","_","each","fileId","file","Uploads","findOneById","store","rs","UploadFS","getStore","getReadStream","push","filename","streamSource","Email","send","to","get","from","subject","html","body","start","end","opentr","closetr","open20td","open60td","closetd","_getLink","attachment","url","title_link","replace","Meteor","sandstorm","match","absoluteUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","generateEml","defer","smarshMissingEmail","timeZone","Rooms","find","forEach","room","smarshHistory","findOne","query","rid","ts","$gt","lastRan","date","Date","rows","users","msgs","time","diff","usernames","join","Messages","message","format","sender","Users","u","indexOf","emails","address","t","messageType","MessageTypes","getType","TAPi18n","__","msg","title","attaches","_loopThroughMessageAttachments","a","image_url","result","upsert","lastResult","smarshJobName","_addSmarshSyncedCronJob","debounce","bindEnvironment","__addSmarshSyncedCronJobDebounced","SyncedCron","nextScheduledAtDate","remove","schedule","parser","text","job","startup"],"mappings":"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","file":"/packages/rocketchat_smarsh-connector.js","sourcesContent":["RocketChat.smarsh = {};\n","RocketChat.settings.addGroup('Smarsh', function addSettings() {\n\tthis.add('Smarsh_Enabled', false, {\n\t\ttype: 'boolean',\n\t\ti18nLabel: 'Smarsh_Enabled',\n\t\tenableQuery: {\n\t\t\t_id: 'From_Email',\n\t\t\tvalue: {\n\t\t\t\t$exists: 1,\n\t\t\t\t$ne: ''\n\t\t\t}\n\t\t}\n\t});\n\tthis.add('Smarsh_Email', '', {\n\t\ttype: 'string',\n\t\ti18nLabel: 'Smarsh_Email',\n\t\tplaceholder: 'email@domain.com'\n\t});\n\tthis.add('Smarsh_MissingEmail_Email', 'no-email@example.com', {\n\t\ttype: 'string',\n\t\ti18nLabel: 'Smarsh_MissingEmail_Email',\n\t\tplaceholder: 'no-email@example.com'\n\t});\n\n\tconst zoneValues = moment.tz.names().map(function _timeZonesToSettings(name) {\n\t\treturn {\n\t\t\tkey: name,\n\t\t\ti18nLabel: name\n\t\t};\n\t});\n\tthis.add('Smarsh_Timezone', 'America/Los_Angeles', {\n\t\ttype: 'select',\n\t\tvalues: zoneValues\n\t});\n\n\tthis.add('Smarsh_Interval', 'every_30_minutes', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'every_30_seconds',\n\t\t\ti18nLabel: 'every_30_seconds'\n\t\t}, {\n\t\t\tkey: 'every_30_minutes',\n\t\t\ti18nLabel: 'every_30_minutes'\n\t\t}, {\n\t\t\tkey: 'every_1_hours',\n\t\t\ti18nLabel: 'every_hour'\n\t\t}, {\n\t\t\tkey: 'every_6_hours',\n\t\t\ti18nLabel: 'every_six_hours'\n\t\t}],\n\t\tenableQuery: {\n\t\t\t_id: 'From_Email',\n\t\t\tvalue: {\n\t\t\t\t$exists: 1,\n\t\t\t\t$ne: ''\n\t\t\t}\n\t\t}\n\t});\n});\n","RocketChat.smarsh.History = new class extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('smarsh_history');\n\t}\n};\n","/* globals UploadFS */\n//Expects the following details:\n// {\n// \tbody: '<table>',\n// \tsubject: 'Rocket.Chat, 17 Users, 24 Messages, 1 File, 799504 Minutes, in #random',\n//  files: ['i3nc9l3mn']\n// }\n\nRocketChat.smarsh.sendEmail = (data) => {\n\tconst attachments = [];\n\n\tif (data.files.length > 0) {\n\t\t_.each(data.files, (fileId) => {\n\t\t\tconst file = RocketChat.models.Uploads.findOneById(fileId);\n\t\t\tif (file.store === 'rocketchat_uploads' || file.store === 'fileSystem') {\n\t\t\t\tconst rs = UploadFS.getStore(file.store).getReadStream(fileId, file);\n\t\t\t\tattachments.push({\n\t\t\t\t\tfilename: file.name,\n\t\t\t\t\tstreamSource: rs\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tEmail.send({\n\t\tto: RocketChat.settings.get('Smarsh_Email'),\n\t\tfrom: RocketChat.settings.get('From_Email'),\n\t\tsubject: data.subject,\n\t\thtml: data.body,\n\t\tattachments: attachments\n\t});\n};\n","const start = '<table style=\"width: 100%; border: 1px solid; border-collapse: collapse; table-layout: fixed; margin-top: 10px; font-size: 12px; word-break: break-word;\"><tbody>';\nconst end = '</tbody></table>';\nconst opentr = '<tr style=\"border: 1px solid;\">';\nconst closetr = '</tr>';\nconst open20td = '<td style=\"border: 1px solid; text-align: center; width: 20%;\">';\nconst open60td = '<td style=\"border: 1px solid; text-align: left; width: 60%; padding: 0 5px;\">';\nconst closetd = '</td>';\n\nfunction _getLink(attachment) {\n\tconst url = attachment.title_link.replace(/ /g, '%20');\n\n\tif (Meteor.settings.public.sandstorm || url.match(/^(https?:)?\\/\\//i)) {\n\t\treturn url;\n\t} else {\n\t\treturn Meteor.absoluteUrl().replace(/\\/$/, '') + __meteor_runtime_config__.ROOT_URL_PATH_PREFIX + url;\n\t}\n}\n\nRocketChat.smarsh.generateEml = () => {\n\tMeteor.defer(() => {\n\t\tconst smarshMissingEmail = RocketChat.settings.get('Smarsh_MissingEmail_Email');\n\t\tconst timeZone = RocketChat.settings.get('Smarsh_Timezone');\n\n\t\tRocketChat.models.Rooms.find().forEach((room) => {\n\t\t\tconst smarshHistory = RocketChat.smarsh.History.findOne({ _id: room._id });\n\t\t\tconst query = { rid: room._id };\n\n\t\t\tif (smarshHistory) {\n\t\t\t\tquery.ts = { $gt: smarshHistory.lastRan };\n\t\t\t}\n\n\t\t\tconst date = new Date();\n\t\t\tconst rows = [];\n\t\t\tconst data = {\n\t\t\t\tusers: [],\n\t\t\t\tmsgs: 0,\n\t\t\t\tfiles: [],\n\t\t\t\ttime: smarshHistory ? moment(date).diff(moment(smarshHistory.lastRan), 'minutes') : moment(date).diff(moment(room.ts), 'minutes'),\n\t\t\t\troom: room.name ? `#${room.name}` : `Direct Message Between: ${room.usernames.join(' & ')}`\n\t\t\t};\n\n\t\t\tRocketChat.models.Messages.find(query).forEach((message) => {\n\t\t\t\trows.push(opentr);\n\n\t\t\t\t//The timestamp\n\t\t\t\trows.push(open20td);\n\t\t\t\trows.push(moment(message.ts).tz(timeZone).format('YYYY-MM-DD HH-mm-ss z'));\n\t\t\t\trows.push(closetd);\n\n\t\t\t\t//The sender\n\t\t\t\trows.push(open20td);\n\t\t\t\tconst sender = RocketChat.models.Users.findOne({ _id: message.u._id });\n\t\t\t\tif (data.users.indexOf(sender._id) === -1) {\n\t\t\t\t\tdata.users.push(sender._id);\n\t\t\t\t}\n\n\t\t\t\t//Get the user's email, can be nothing if it is an unconfigured bot account (like rocket.cat)\n\t\t\t\tif (sender.emails && sender.emails[0] && sender.emails[0].address) {\n\t\t\t\t\trows.push(`${sender.name} &lt;${sender.emails[0].address}&gt;`);\n\t\t\t\t} else {\n\t\t\t\t\trows.push(`${sender.name} &lt;${smarshMissingEmail}&gt;`);\n\t\t\t\t}\n\t\t\t\trows.push(closetd);\n\n\t\t\t\t//The message\n\t\t\t\trows.push(open60td);\n\t\t\t\tdata.msgs++;\n\t\t\t\tif (message.t) {\n\t\t\t\t\tconst messageType = RocketChat.MessageTypes.getType(message);\n\t\t\t\t\tif (messageType) {\n\t\t\t\t\t\trows.push(TAPi18n.__(messageType.message, messageType.data ? messageType.data(message) : '', 'en'));\n\t\t\t\t\t} else {\n\t\t\t\t\t\trows.push(`${message.msg} (${message.t})`);\n\t\t\t\t\t}\n\t\t\t\t} else if (message.file) {\n\t\t\t\t\tdata.files.push(message.file._id);\n\t\t\t\t\trows.push(`${message.attachments[0].title} (${_getLink(message.attachments[0])})`);\n\t\t\t\t} else if (message.attachments) {\n\t\t\t\t\tconst attaches = [];\n\t\t\t\t\t_.each(message.attachments, function _loopThroughMessageAttachments(a) {\n\t\t\t\t\t\tif (a.image_url) {\n\t\t\t\t\t\t\tattaches.push(a.image_url);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t//TODO: Verify other type of attachments which need to be handled that aren't file uploads and image urls\n\t\t\t\t\t\t// } else {\n\t\t\t\t\t\t// \tconsole.log(a);\n\t\t\t\t\t\t// }\n\t\t\t\t\t});\n\n\t\t\t\t\trows.push(`${message.msg} (${attaches.join(', ')})`);\n\t\t\t\t} else {\n\t\t\t\t\trows.push(message.msg);\n\t\t\t\t}\n\t\t\t\trows.push(closetd);\n\n\t\t\t\trows.push(closetr);\n\t\t\t});\n\n\t\t\tif (rows.length !== 0) {\n\t\t\t\tconst result = start + rows.join('') + end;\n\n\t\t\t\tRocketChat.smarsh.History.upsert({ _id: room._id }, {\n\t\t\t\t\t_id: room._id,\n\t\t\t\t\tlastRan: date,\n\t\t\t\t\tlastResult: result\n\t\t\t\t});\n\n\t\t\t\tRocketChat.smarsh.sendEmail({\n\t\t\t\t\tbody: result,\n\t\t\t\t\tsubject: `Rocket.Chat, ${data.users.length} Users, ${data.msgs} Messages, ${data.files.length} Files, ${data.time} Minutes, in ${data.room}`,\n\t\t\t\t\tfiles: data.files\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t});\n};\n","/* globals SyncedCron */\nconst smarshJobName = 'Smarsh EML Connector';\n\nconst _addSmarshSyncedCronJob = _.debounce(Meteor.bindEnvironment(function __addSmarshSyncedCronJobDebounced() {\n\tif (SyncedCron.nextScheduledAtDate(smarshJobName)) {\n\t\tSyncedCron.remove(smarshJobName);\n\t}\n\n\tif (RocketChat.settings.get('Smarsh_Enabled') && RocketChat.settings.get('Smarsh_Email') !== '' && RocketChat.settings.get('From_Email') !== '') {\n\t\tSyncedCron.add({\n\t\t\tname: smarshJobName,\n\t\t\tschedule: (parser) => parser.text(RocketChat.settings.get('Smarsh_Interval').replace(/_/g, ' ')),\n\t\t\tjob: RocketChat.smarsh.generateEml\n\t\t});\n\t}\n}), 500);\n\nMeteor.startup(() => {\n\tMeteor.defer(() => {\n\t\t_addSmarshSyncedCronJob();\n\n\t\tRocketChat.settings.get('Smarsh_Interval', _addSmarshSyncedCronJob);\n\t\tRocketChat.settings.get('Smarsh_Enabled', _addSmarshSyncedCronJob);\n\t\tRocketChat.settings.get('Smarsh_Email', _addSmarshSyncedCronJob);\n\t\tRocketChat.settings.get('From_Email', _addSmarshSyncedCronJob);\n\t});\n});\n"]}