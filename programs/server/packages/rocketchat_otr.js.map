{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:otr/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:otr/server/models/Messages.js","meteor://ðŸ’»app/packages/rocketchat:otr/server/methods/deleteOldOTRMessages.js","meteor://ðŸ’»app/packages/rocketchat:otr/server/methods/updateOTRAck.js"],"names":["RocketChat","settings","addGroup","add","type","i18nLabel","models","Messages","deleteOldOTRMessages","roomId","ts","query","rid","t","$lte","remove","updateOTRAck","_id","otrAck","update","$set","Meteor","methods","userId","Error","method","now","Date","subscription","Subscriptions","findOneByRoomIdAndUserId","ack"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,WAAWC,QAAX,CAAoBC,QAApB,CAA6B,KAA7B,EAAoC,YAAW;AAC9C,MAAKC,GAAL,CAAS,YAAT,EAAuB,IAAvB,EAA6B;AAC5BC,QAAM,SADsB;AAE5BC,aAAW,SAFiB;AAG5B,YAAQ;AAHoB,EAA7B;AAKA,CAND,4G;;;;;;;;;;;ACAAL,WAAWM,MAAX,CAAkBC,QAAlB,CAA2BC,oBAA3B,GAAkD,UAASC,MAAT,EAAiBC,EAAjB,EAAqB;AACtE,KAAIC,QAAQ,EAAEC,KAAKH,MAAP,EAAeI,GAAG,KAAlB,EAAyBH,IAAI,EAAEI,MAAMJ,EAAR,EAA7B,EAAZ;AACA,QAAO,KAAKK,MAAL,CAAYJ,KAAZ,CAAP;AACA,CAHD;;AAKAX,WAAWM,MAAX,CAAkBC,QAAlB,CAA2BS,YAA3B,GAA0C,UAASC,GAAT,EAAcC,MAAd,EAAsB;AAC/D,KAAIP,QAAQ,EAAEM,KAAKA,GAAP,EAAZ;AACA,KAAIE,SAAS,EAAEC,MAAM,EAAEF,QAAQA,MAAV,EAAR,EAAb;AACA,QAAO,KAAKC,MAAL,CAAYR,KAAZ,EAAmBQ,MAAnB,CAAP;AACA,CAJD,6G;;;;;;;;;;;ACLAE,OAAOC,OAAP,CAAe;AACdd;AAAsB,gCAASC,MAAT,EAAiB;AACtC,OAAI,CAACY,OAAOE,MAAP,EAAL,EAAsB;AACrB,UAAM,IAAIF,OAAOG,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD,EAAEC,QAAQ,sBAAV,EAAvD,CAAN;AACA;;AAED,OAAMC,MAAM,IAAIC,IAAJ,EAAZ;AACA,OAAMC,eAAe5B,WAAWM,MAAX,CAAkBuB,aAAlB,CAAgCC,wBAAhC,CAAyDrB,MAAzD,EAAiEY,OAAOE,MAAP,EAAjE,CAArB;AACA,OAAIK,gBAAgBA,aAAaf,CAAb,KAAmB,GAAvC,EAA4C;AAC3Cb,eAAWM,MAAX,CAAkBC,QAAlB,CAA2BC,oBAA3B,CAAgDC,MAAhD,EAAwDiB,GAAxD;AACA,IAFD,MAEO;AACN,UAAM,IAAIL,OAAOG,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD,EAAEC,QAAQ,sBAAV,EAAvD,CAAN;AACA;AACD;;AAZD;AAAA;AADc,CAAf,4G;;;;;;;;;;;ACAAJ,OAAOC,OAAP,CAAe;AACdN;AAAc,wBAASC,GAAT,EAAcc,GAAd,EAAmB;AAChC,OAAI,CAACV,OAAOE,MAAP,EAAL,EAAsB;AACrB,UAAM,IAAIF,OAAOG,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD,EAAEC,QAAQ,cAAV,EAAvD,CAAN;AACA;AACDzB,cAAWM,MAAX,CAAkBC,QAAlB,CAA2BS,YAA3B,CAAwCC,GAAxC,EAA6Cc,GAA7C;AACA;;AALD;AAAA;AADc,CAAf,4G","file":"/packages/rocketchat_otr.js","sourcesContent":["RocketChat.settings.addGroup('OTR', function() {\n\tthis.add('OTR_Enable', true, {\n\t\ttype: 'boolean',\n\t\ti18nLabel: 'Enabled',\n\t\tpublic: true\n\t});\n});\n","RocketChat.models.Messages.deleteOldOTRMessages = function(roomId, ts) {\n\tvar query = { rid: roomId, t: 'otr', ts: { $lte: ts } };\n\treturn this.remove(query);\n};\n\nRocketChat.models.Messages.updateOTRAck = function(_id, otrAck) {\n\tvar query = { _id: _id };\n\tvar update = { $set: { otrAck: otrAck } };\n\treturn this.update(query, update);\n};\n","Meteor.methods({\n\tdeleteOldOTRMessages: function(roomId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'deleteOldOTRMessages' });\n\t\t}\n\n\t\tconst now = new Date();\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(roomId, Meteor.userId());\n\t\tif (subscription && subscription.t === 'd') {\n\t\t\tRocketChat.models.Messages.deleteOldOTRMessages(roomId, now);\n\t\t} else {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'deleteOldOTRMessages' });\n\t\t}\n\t}\n});\n","Meteor.methods({\n\tupdateOTRAck: function(_id, ack) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'updateOTRAck' });\n\t\t}\n\t\tRocketChat.models.Messages.updateOTRAck(_id, ack);\n\t}\n});\n"]}